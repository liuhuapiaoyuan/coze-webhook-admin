This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-01-10T06:50:56.563Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.dockerignore
.env.template
.gitignore
.repomixignore
components.json
docker/.env.template
docker/docker-compose.yml
docker/Dockerfile
docker/release.sh
docker/start.sh
docs/æ¶æ„-CRUD.md
docs/æœ€ä½³å®è·µ/class-transformer-1.md
docs/æœ€ä½³å®è·µ/class-transformer-2.md
docs/rules/crud.rules.md
docs/server-ui/page-list.md
docs/server-ui/page-table.md
docs/shared-ui/smart-pagination.md
eslint.config.mjs
global.d.ts
next.config.ts
package.json
patches/@elysiajs__swagger@1.2.0.patch
postcss.config.mjs
prettier.config.mjs
prisma/schema.prisma
README.MD
repomix.config.json
src/api/index.ts
src/api/lib/json.bigint.ts
src/api/middlewares/auth.ts
src/app/admin/admins/_components/admin-form.tsx
src/app/admin/admins/[id]/loading.tsx
src/app/admin/admins/[id]/page.tsx
src/app/admin/admins/actions.ts
src/app/admin/admins/columns.tsx
src/app/admin/admins/new/loading.tsx
src/app/admin/admins/new/page.tsx
src/app/admin/admins/page.tsx
src/app/admin/api-endpoints/_components/basic-info.tsx
src/app/admin/api-endpoints/_components/detail-tabs.tsx
src/app/admin/api-endpoints/_components/form.tsx
src/app/admin/api-endpoints/_components/keys-list.tsx
src/app/admin/api-endpoints/_components/records-list.tsx
src/app/admin/api-endpoints/[id]/detail/page.tsx
src/app/admin/api-endpoints/[id]/page.tsx
src/app/admin/api-endpoints/actions.ts
src/app/admin/api-endpoints/columns.tsx
src/app/admin/api-endpoints/new/page.tsx
src/app/admin/api-endpoints/page.tsx
src/app/admin/api-keys/_components/form.tsx
src/app/admin/api-keys/[id]/page.tsx
src/app/admin/api-keys/actions.ts
src/app/admin/api-keys/columns.tsx
src/app/admin/api-keys/new/page.tsx
src/app/admin/api-keys/page.tsx
src/app/admin/api-logs/[id]/page.tsx
src/app/admin/api-logs/actions.ts
src/app/admin/api-logs/columns.tsx
src/app/admin/api-logs/page.tsx
src/app/admin/dashboard/_components/new-users.tsx
src/app/admin/dashboard/_components/welcome.tsx
src/app/admin/dashboard/page.tsx
src/app/admin/layout.tsx
src/app/admin/loading.tsx
src/app/admin/menus/_components/menu-form.tsx
src/app/admin/menus/_components/remove-button.tsx
src/app/admin/menus/[id]/page.tsx
src/app/admin/menus/actions.ts
src/app/admin/menus/columns.tsx
src/app/admin/menus/new/page.tsx
src/app/admin/menus/page.tsx
src/app/admin/permissions/_components/permission-form.tsx
src/app/admin/permissions/_components/permission-select.tsx
src/app/admin/permissions/_components/remove-button.tsx
src/app/admin/permissions/_components/schema.ts
src/app/admin/permissions/[id]/page.tsx
src/app/admin/permissions/actions.ts
src/app/admin/permissions/columns.tsx
src/app/admin/permissions/new/drawer.tsx
src/app/admin/permissions/new/page.tsx
src/app/admin/permissions/page.tsx
src/app/admin/profile/_components/form.tsx
src/app/admin/profile/actions.ts
src/app/admin/profile/loading.tsx
src/app/admin/profile/page.tsx
src/app/admin/roles/_components/remove-button.tsx
src/app/admin/roles/_components/role-form.tsx
src/app/admin/roles/[id]/page.tsx
src/app/admin/roles/actions.ts
src/app/admin/roles/columns.tsx
src/app/admin/roles/new/page.tsx
src/app/admin/roles/page.tsx
src/app/admin/webhooks/_components/form.tsx
src/app/admin/webhooks/[id]/page.tsx
src/app/admin/webhooks/actions.ts
src/app/admin/webhooks/columns.tsx
src/app/admin/webhooks/new/page.tsx
src/app/admin/webhooks/page.tsx
src/app/api/[[...slugs]]/route.ts
src/app/api/[api_id]/route.ts
src/app/api/admin/api-endpoints/[id]/keys/route.ts
src/app/api/auth/[...nextauth]/route.ts
src/app/api/v1/chat/completion/route.ts
src/app/api/v1/chat/completion/schema.ts
src/app/global.css
src/app/layout.tsx
src/app/login/page.tsx
src/app/not-found.tsx
src/app/page.tsx
src/app/webhook/[id]/route.ts
src/app/webhook/lib.ts
src/hooks/use-mobile.tsx
src/hooks/use-toast.ts
src/instrumentation.ts
src/lib/auth.base.ts
src/lib/auth.ts
src/lib/cache.ts
src/lib/db.ts
src/lib/upload.ts
src/lib/utils.ts
src/lib/validations/auth.ts
src/lib/validations/device.ts
src/middleware.ts
src/service/admin.service.ts
src/service/api-endpoints.service.ts
src/service/coze-webhook.ts
src/service/enum/ADMIN_ROLE.ts
src/service/menu.service.ts
src/service/permission.service.ts
src/service/role.service.ts

================================================================
Files
================================================================

================
File: .dockerignore
================
# Dependencies
packages
node_modules
.pnp
.pnp.js

# Testing
coverage

# Next.js
.next/
out/

# Production
build

# Misc
.DS_Store
*.pem

# Debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Local env files
.env*.local

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts

# IDEs and editors
.idea
.vscode
*.swp
*.swo

# OS generated
Thumbs.db

================
File: .env.template
================
AUTH_SECRET="orpsHWZ8FKc3475/ivKpXRQ+BN8RT8f00QHDoBpmcqw=" # Added by `npx auth`. Read more: https://cli.authjs.dev

DATABASE_URL="file:./dev.db"

NEXT_PUBLIC_API_URL="http://localhost:3000"

================
File: .gitignore
================
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# env files (can opt-in for committing if needed)
.env*
!.env.template

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# database
*.db
dev.db

================
File: .repomixignore
================
# Add patterns to ignore here, one per line
# Example:
# *.log
# tmp/
src/components/*
.cursorrules
.windsurfrules

admins/*
roles/*
tsconfig.json
tailwind.config.ts

================
File: components.json
================
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/app/global.css",
    "baseColor": "zinc",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}

================
File: docker/.env.template
================
AUTH_SECRET="orpsHWZ8FKc3475/ivKpXRQ+BN8RT8f00QHDoBpmcqw=" # Added by `npx auth`. Read more: https://cli.authjs.dev

DATABASE_URL="file:./dev.db"

================
File: docker/docker-compose.yml
================
version: "3"

services:
  ai-human:
    image: liuhuapiaoyuan/ai-human
    ports:
      - "8124:3000"
    env_file:
      - ./.env

================
File: docker/Dockerfile
================
FROM node:22-alpine AS base

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable
COPY . /app
WORKDIR /app

FROM base AS builder
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile
COPY  ./next.docker.ts  ./next.config.ts
RUN pnpm run build


# åˆ›å»ºè¿è¡Œç¯å¢ƒ
FROM base as runtime
# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

COPY --from=builder /app/public ./public
# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

 


EXPOSE 3000
ENV PORT 3000


CMD ["node", "server.js"]

================
File: docker/release.sh
================
#!/bin/bash



# ä½¿è„šæœ¬åœ¨é‡åˆ°ä»»ä½•é”™è¯¯æ—¶è‡ªåŠ¨é€€å‡º
set -e

# å®šä¹‰ä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°
error_handler() {
    local exit_code=$?
    local line_no=$1
    echo "Error on line $line_no. Exit code: $exit_code"
    exit $exit_code
}

# ä½¿ç”¨trapå‘½ä»¤æ•è·é”™è¯¯å¹¶è°ƒç”¨é”™è¯¯å¤„ç†å‡½æ•°
trap 'error_handler $LINENO' ERR


VERSION=$(date +%Y%m%d%H%M)
BACK_IMAGE_NAME=liuhuapiaoyuan/ai-human
# ç¼–è¯‘åç«¯
echo "Building backend..."
docker build -f ./docker/Dockerfile  -t $BACK_IMAGE_NAME:latest -t $BACK_IMAGE_NAME:$VERSION .
 
echo "Build complete."


echo "Pushing images to Docker Hub..."

docker push $BACK_IMAGE_NAME:latest
docker push $BACK_IMAGE_NAME:$VERSION

 
echo "Push complete."

================
File: docker/start.sh
================
docker-compose -p ai-human pull
docker-compose -p ai-human down
docker-compose -p ai-human up -d

================
File: docs/æ¶æ„-CRUD.md
================
å®Œæ•´çš„CURDåˆ›å»ºæµç¨‹:

1. åˆ›å»ºprisma.schema

2. åˆ›å»º service/model.service.ts

3. åˆ›å»º page/(admin)/actions.ts

4. åˆ›å»ºé¡µé¢ page/(admin)/page.tsx

5. åˆ›å»ºæ–°å¢é¡µé¢ page/(admin)/new/page.tsx

6. åˆ›å»ºç¼–è¾‘é¡µé¢ page/(admin)/[id]/page.tsx

7. åˆ›å»ºè¡¨å•ç»„ä»¶ page/(admin)/\_components/form.tsx

================
File: docs/æœ€ä½³å®è·µ/class-transformer-1.md
================
### ä½¿ç”¨ `@Transform` è£…é¥°å™¨å®ç°è‡ªå®šä¹‰è½¬æ¢ï¼šå®ç°å­˜å‚¨è·Ÿä¸šåŠ¡å¯¹è±¡çš„è½¬æ¢

åœ¨ TypeScript é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹æ•°æ®è¿›è¡ŒæŸäº›è‡ªå®šä¹‰è½¬æ¢ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤–éƒ¨æ•°æ®ï¼ˆä¾‹å¦‚ API è¯·æ±‚çš„å“åº”ï¼‰å’Œä¸šåŠ¡é€»è¾‘å±‚çš„æ•°æ®ä¹‹é—´çš„è½¬æ¢æ—¶ã€‚`class-transformer` åº“æä¾›äº†ä¸€ä¸ªéå¸¸å®ç”¨çš„å·¥å…·â€”â€”`@Transform` è£…é¥°å™¨ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ–¹ä¾¿åœ°å®ç°è‡ªå®šä¹‰çš„å­—æ®µè½¬æ¢ã€‚

æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åˆ©ç”¨ `@Transform` è£…é¥°å™¨å°†ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¹¶é€šè¿‡å®é™…ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨ä¸šåŠ¡å¯¹è±¡ä¸­ä½¿ç”¨è¿™ç§è½¬æ¢ã€‚

### é—®é¢˜èƒŒæ™¯

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª `UserBase` ç±»ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªå­—æ®µ `tags`ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡å¯¹è±¡ `User` ä¸­ï¼Œ`tags` éœ€è¦æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚å› æ­¤ï¼Œåœ¨ä»æ•°æ®åº“æˆ– API æ¥æ”¶æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºä¸€ä¸ªæ•°ç»„ã€‚é€šè¿‡ä½¿ç”¨ `class-transformer` æä¾›çš„ `@Transform` è£…é¥°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°è¿™ä¸€ç‚¹ã€‚

### è§£å†³æ–¹æ¡ˆ

`class-transformer` æä¾›äº† `@Transform` è£…é¥°å™¨ï¼Œå¯ä»¥ç”¨æ¥ä¸ºå­—æ®µå®šä¹‰è‡ªå®šä¹‰çš„è½¬æ¢é€»è¾‘ã€‚æˆ‘ä»¬å°†ä¸º `tags` å­—æ®µåˆ›å»ºä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå­—ç¬¦ä¸²æ•°ç»„ã€‚

### æ­¥éª¤

1. ä½¿ç”¨ `@Transform` è£…é¥°å™¨æ¥å¤„ç†å­—æ®µçš„è½¬æ¢ã€‚
2. ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„ã€‚
3. ä½¿ç”¨ `plainToClass` æ¥è¿›è¡Œå¯¹è±¡è½¬æ¢ã€‚

### ä»£ç å®ç°

```typescript
import { plainToClass, Transform } from "class-transformer";

// åŸå§‹ç±»ï¼Œtags æ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
class UserBase {
  tags: string;
}

// æ”¹è¿›åçš„ç±»ï¼Œtags æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„
class User {
  @Transform(({ value }) => value.split(","), { toClassOnly: true }) // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
  tags: string[];

  constructor(tags: string[]) {
    this.tags = tags;
  }
}

// ç”¨æˆ·ä¼ å…¥çš„æ•°æ®æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ tags æ˜¯é€—å·åˆ†éš”çš„
const userBaseObj = {
  tags: "tag1,tag2,tag3",
};

// ä½¿ç”¨ plainToClass æ¥è¿›è¡Œè½¬æ¢
const user = plainToClass(User, userBaseObj);

console.log(user instanceof User); // true
console.log(user.tags); // ["tag1", "tag2", "tag3"]
```

### è§£æ

1. **åŸå§‹ç±» `UserBase`**ï¼š
   `UserBase` ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå­—æ®µ `tags`ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„é€—å·åˆ†éš”å­—ç¬¦ä¸²ã€‚åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œç±»ä¼¼çš„å­—æ®µå¯èƒ½æ¥è‡ªäºæ•°æ®åº“æˆ–è€…å¤–éƒ¨ API çš„å“åº”ã€‚

2. **ç›®æ ‡ç±» `User`**ï¼š
   `User` ç±»ä¸­çš„ `tags` å­—æ®µå®šä¹‰ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ `@Transform` è£…é¥°å™¨æ¥å®ç°ä»å­—ç¬¦ä¸²åˆ°æ•°ç»„çš„è½¬æ¢ã€‚

3. **`@Transform` è£…é¥°å™¨**ï¼š
   `@Transform` è£…é¥°å™¨çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå…¶ä¸­åŒ…å«äº†åŸå§‹å­—æ®µçš„å€¼ã€‚æˆ‘ä»¬åˆ©ç”¨ `split(',')` æ–¹æ³•å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚

   `toClassOnly: true` çš„é…ç½®è¡¨ç¤ºè¿™ä¸ªè½¬æ¢åªä¼šåœ¨ `plainToClass` æ—¶ç”Ÿæ•ˆï¼Œå³å°†æ™®é€šå¯¹è±¡è½¬æ¢ä¸ºç±»å®ä¾‹æ—¶ï¼Œè€Œä¸ä¼šå½±å“åå‘è½¬æ¢ï¼ˆå³ç±»å®ä¾‹è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡æ—¶ï¼‰ã€‚

4. **è½¬æ¢è¿‡ç¨‹**ï¼š
   å½“æˆ‘ä»¬è°ƒç”¨ `plainToClass` æ–¹æ³•æ—¶ï¼Œ`tags` å­—æ®µä¼šä»å­—ç¬¦ä¸² `"tag1,tag2,tag3"` è½¬æ¢ä¸ºæ•°ç»„ `["tag1", "tag2", "tag3"]`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„ `User` ç±»å®ä¾‹ã€‚

### å°ç»“

é€šè¿‡ä½¿ç”¨ `class-transformer` æä¾›çš„ `@Transform` è£…é¥°å™¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçµæ´»åœ°è¿›è¡Œå­—æ®µçš„ç±»å‹è½¬æ¢ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¯¹å­—æ®µè¿›è¡Œä¸€äº›ç‰¹å®šå¤„ç†ï¼ˆä¾‹å¦‚å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„ï¼‰æ—¶ã€‚è¿™ç§æ–¹å¼ä¸ä»…ç®€åŒ–äº†ä»£ç çš„ç»´æŠ¤ï¼Œè¿˜èƒ½å¸®åŠ©æˆ‘ä»¬åœ¨ ORM å¯¹è±¡å’Œä¸šåŠ¡å¯¹è±¡ä¹‹é—´è¿›è¡Œé«˜æ•ˆçš„è½¬æ¢ã€‚

### å®é™…åº”ç”¨åœºæ™¯

è¿™ç§è½¬æ¢æ–¹å¼åœ¨å®é™…å¼€å‘ä¸­éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸æ•°æ®åº“æˆ–å¤–éƒ¨ API äº¤äº’æ—¶ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬ä½¿ç”¨ Prisma ORM è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œå¹¶ä¸”éœ€è¦å°†æ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å­—æ®µï¼ˆå¦‚ `tags`ï¼‰è½¬æ¢ä¸ºä¸šåŠ¡å¯¹è±¡ä¸­çš„æ•°ç»„å­—æ®µï¼Œè¿™æ—¶ `@Transform` è£…é¥°å™¨å°±èƒ½éå¸¸æ–¹ä¾¿åœ°å¸®åŠ©æˆ‘ä»¬å®ç°è¿™ç§éœ€æ±‚ã€‚

æ€»çš„æ¥è¯´ï¼Œ`class-transformer` æä¾›äº†éå¸¸å¼ºå¤§ä¸”çµæ´»çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿè®©å¼€å‘è€…è½»æ¾å¤„ç†å¤æ‚çš„æ•°æ®è½¬æ¢é€»è¾‘ã€‚

================
File: docs/æœ€ä½³å®è·µ/class-transformer-2.md
================
### æ‰©å±•ï¼šååºåˆ—åŒ–å°† `User` è½¬æ¢ä¸º `UserBase`

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `@Transform` è£…é¥°å™¨å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ‰©å±•è¯¥ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå°†ä¸€ä¸ª `User` ç±»å®ä¾‹è½¬æ¢å› `UserBase` ç±»å®ä¾‹ï¼Œå°¤å…¶æ˜¯å½“ `User` ç±»ä¸­çš„å­—æ®µæ˜¯æ•°ç»„æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦åœ¨ä¸åŒçš„å±‚ä¹‹é—´è¿›è¡Œæ•°æ®è½¬æ¢ã€‚ä¾‹å¦‚ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªä¸æ•°æ®åº“æˆ– API äº¤äº’çš„åŸå§‹æ•°æ®å¯¹è±¡ï¼ˆ`UserBase`ï¼‰ï¼Œä»¥åŠä¸€ä¸ªä¸šåŠ¡é€»è¾‘å±‚çš„æ•°æ®å¯¹è±¡ï¼ˆ`User`ï¼‰ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡ŒåŒå‘è½¬æ¢â€”â€”ä»åŸå§‹æ•°æ®å¯¹è±¡åˆ°ä¸šåŠ¡å¯¹è±¡ï¼ˆåºåˆ—åŒ–ï¼‰ï¼Œä»¥åŠä»ä¸šåŠ¡å¯¹è±¡åˆ°åŸå§‹æ•°æ®å¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰ã€‚é€šè¿‡ `class-transformer` æä¾›çš„ `@Transform` è£…é¥°å™¨å’Œ `toClassOnly` é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°å®ç°è¿™ç§åŒå‘è½¬æ¢ã€‚

### ååºåˆ—åŒ–ï¼šå°† `User` è½¬æ¢ä¸º `UserBase`

å‡è®¾æˆ‘ä»¬åœ¨ååºåˆ—åŒ–æ—¶éœ€è¦å°† `User` ç±»çš„ `tags` å­—æ®µä»å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢å›é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨ `@Transform` è£…é¥°å™¨ï¼Œåªæ˜¯è¿™æ¬¡æ˜¯å°†æ•°ç»„è½¬æ¢å›å­—ç¬¦ä¸²ã€‚

### ä»£ç å®ç°

```typescript
import { plainToClass, classToPlain, Transform } from "class-transformer";

// åŸå§‹ç±»ï¼Œtags æ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
class UserBase {
  tags: string;
}

// æ”¹è¿›åçš„ç±»ï¼Œtags æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„
class User {
  @Transform(({ value }) => value.split(","), { toClassOnly: true }) // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
  @Transform(({ value }) => value.join(","), { toPlainOnly: true }) // å°†æ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
  tags: string[];

  constructor(tags: string[]) {
    this.tags = tags;
  }
}

// ç”¨æˆ·ä¼ å…¥çš„æ•°æ®æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ tags æ˜¯é€—å·åˆ†éš”çš„
const userBaseObj = {
  tags: "tag1,tag2,tag3",
};

// ä½¿ç”¨ plainToClass æ¥è¿›è¡Œè½¬æ¢
const user = plainToClass(User, userBaseObj);

console.log(user instanceof User); // true
console.log(user.tags); // ["tag1", "tag2", "tag3"]

// å°† User å®ä¾‹è½¬æ¢å› UserBase
const userBaseObjFromUser = classToPlain(user);
console.log(userBaseObjFromUser); // { tags: 'tag1,tag2,tag3' }
```

### è§£æ

1. **`User` ç±»ä¸­çš„ `tags` å­—æ®µ**ï¼š
   åœ¨ `User` ç±»ä¸­ï¼Œ`tags` å­—æ®µå®šä¹‰ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚æˆ‘ä»¬åœ¨è¯¥å­—æ®µä¸Šä½¿ç”¨äº†ä¸¤ä¸ª `@Transform` è£…é¥°å™¨ï¼š

   - ç¬¬ä¸€ä¸ªè£…é¥°å™¨å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ `'tag1,tag2,tag3'`ï¼‰è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„ã€‚
   - ç¬¬äºŒä¸ªè£…é¥°å™¨åˆ™æ˜¯åå‘è½¬æ¢ï¼Œå®ƒå°†å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢å›é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªè½¬æ¢å‡½æ•°ä½¿ç”¨ `join(',')` æ–¹æ³•å°†æ•°ç»„ä¸­çš„å…ƒç´ è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

2. **åºåˆ—åŒ–ï¼ˆ`plainToClass`ï¼‰**ï¼š
   åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åŸå§‹æ•°æ®å¯¹è±¡ï¼ˆ`userBaseObj`ï¼‰è½¬æ¢ä¸º `User` ç±»å®ä¾‹ã€‚æ­¤æ—¶ï¼Œ`tags` å­—æ®µä¼šè¢«è½¬æ¢ä¸ºæ•°ç»„ `["tag1", "tag2", "tag3"]`ã€‚

3. **ååºåˆ—åŒ–ï¼ˆ`classToPlain`ï¼‰**ï¼š
   åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°† `User` ç±»å®ä¾‹ï¼ˆ`user`ï¼‰è½¬æ¢å›æ™®é€šçš„å¯¹è±¡ã€‚æ­¤æ—¶ï¼Œ`tags` å­—æ®µä¼šè¢«è½¬æ¢å›é€—å·åˆ†éš”çš„å­—ç¬¦ä¸² `'tag1,tag2,tag3'`ã€‚

   `toPlainOnly: true` è¡¨ç¤ºè¿™ä¸ªè½¬æ¢åªä¼šåœ¨ä»ç±»å®ä¾‹è½¬æ¢å›æ™®é€šå¯¹è±¡æ—¶ç”Ÿæ•ˆï¼Œè€Œä¸ä¼šåœ¨å°†æ™®é€šå¯¹è±¡è½¬æ¢ä¸ºç±»å®ä¾‹æ—¶è¿›è¡Œã€‚è¿™å¯ä»¥ç¡®ä¿æˆ‘ä»¬åœ¨ `classToPlain` æ—¶è¿›è¡Œè½¬æ¢ï¼Œè€Œåœ¨ `plainToClass` æ—¶ä¸åšä¿®æ”¹ã€‚

### å°ç»“

é€šè¿‡ä½¿ç”¨ `@Transform` è£…é¥°å™¨ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥è½»æ¾åœ°å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿˜å¯ä»¥åœ¨åå‘è½¬æ¢æ—¶å°†å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢å›é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚è¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸åŒçš„æ•°æ®è¡¨ç¤ºï¼ˆä¾‹å¦‚æ•°æ®åº“å­˜å‚¨æ ¼å¼å’Œä¸šåŠ¡é€»è¾‘å±‚çš„æ ¼å¼ï¼‰ä¹‹é—´è¿›è¡Œçµæ´»è½¬æ¢ã€‚

è¿™ç§æ–¹å¼ä¸ä»…èƒ½ç®€åŒ–æ•°æ®çš„è½¬æ¢é€»è¾‘ï¼Œè¿˜èƒ½ä¿è¯åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä¿æŒä¸€è‡´çš„å¤„ç†æ–¹å¼ï¼Œå°¤å…¶é€‚ç”¨äºåœ¨ ORM å¯¹è±¡ä¸ä¸šåŠ¡å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ Prisma ORM æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å®ç°å­—æ®µç±»å‹çš„è½¬æ¢ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨æ“ä½œæ•°æ®æ—¶èƒ½å¤Ÿé¿å…æ‰‹åŠ¨è½¬æ¢çš„ç¹çã€‚

è¿™ç§çµæ´»çš„è½¬æ¢æ–¹å¼ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨è¿›è¡Œæ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œèƒ½å¤Ÿæ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚

================
File: docs/rules/crud.rules.md
================
1. åˆ›å»ºå®Œæ•´çš„CRUDæ¶æ„å¦‚ä¸‹ï¼š

- åˆ›å»º /admin/{module}/page.tsx
  import { getAdmins } from "./actions";
  import { columns } from "./columns";
  import { Button } from "@/components/ui/button";
  import { Plus } from "lucide-react";
  import Link from "next/link";
  import PageTable from "@/components/page-table";

export default async function AdminsPage(props: PageProps) {
return (

<div className="container mx-auto py-10">
<div className="mb-6 flex items-center justify-between">
<h1 className="text-2xl font-bold">ç®¡ç†å‘˜ç®¡ç†</h1>
<Link href="/admins/new">
<Button>
<Plus className="mr-2 h-4 w-4" />
æ–°å»ºç®¡ç†å‘˜
</Button>
</Link>
</div>
<PageTable
basePath="/admins"
load={(data) =>
getAdmins({
page: data.page,
pageSize: data.pageSize,
where: data.keyword
? {
OR: [
{ email: { contains: data.keyword } },
{ username: { contains: data.keyword } },
{ nickname: { contains: data.keyword } },
],
}
: {},
})
}
columns={columns}
searchParams={props.searchParams}
/>
</div>
);
}

- åˆ›å»º /admin/{module}/action.ts

  - åŒ…å«æ‰€æœ‰çš„CRUDæ“ä½œ
  - ä½¿ç”¨ import { db } from "@/lib/db"; å¯¼å…¥prisma
  - ä¾‹å¦‚åˆ†é¡µæ¥å£å¦‚ä¸‹ï¼š
    // è·å–ç®¡ç†å‘˜åˆ—è¡¨
    async function getAdmins(
    query: PageableQuery<typeof db.admin> = { page: 1, pageSize: 10 }
    ) {
    const skip = (query.page - 1) \* query.pageSize;
    const [total, data] = await Promise.all([
    db.admin.count({ where: query.where }),
    db.admin.findMany({
    skip,
    take: query.pageSize,
    orderBy: {
    createdAt: "desc",
    },
    where: query.where,
    }),
    ]);

    return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
    };
    }

- åˆ›å»º /admin/{module}/columns.tsx

```typescript
"use client";
import { ColumnDef } from "@tanstack/react-table";
import { Menu } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deleteMenu } from "./actions";
import Link from "next/link";
import { RemoveButton } from "@/components/remove-button";

export const columns: ColumnDef<Menu>[] = [
  {
    accessorKey: "name",
    header: "èœå•åç§°",
  },
  {
    accessorKey: "url",
    header: "URL",
  },
  {
    accessorKey: "orderNum",
    header: "æ’åº",
  },
  {
    accessorKey: "icon",
    header: "å›¾æ ‡",
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const menu = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå•å—ï¼Ÿ")) return;
        await deleteMenu(menu.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/menus/${menu.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];
```

- åˆ›å»ºè¡¨å• /admin/{module}/\_components/form.tsx

```tsx
"use client";
import React, { useState, useEffect } from "react";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";
import { Menu } from "@prisma/client";
import { createMenu, updateMenu, fetchMenus } from "../actions";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from "@/components/ui/select";
import { useToast } from "@/hooks/use-toast";

const menuFormSchema = z.object({
  name: z.string().min(1, "èœå•åç§°ä¸èƒ½ä¸ºç©º"),
  url: z.string().min(1, "URLä¸èƒ½ä¸ºç©º"),
  orderNum: z.number().min(0, "æ’åºå·å¿…é¡»å¤§äºç­‰äº0"),
  parentId: z.string().nullable(),
  icon: z.string().optional().nullable(),
});

type MenuFormValues = z.infer<typeof menuFormSchema>;

interface MenuFormProps {
  initialData?: Menu;
}

export function MenuForm({ initialData }: MenuFormProps) {
  const router = useRouter();
  const [menus, setMenus] = useState<Menu[]>([]);
  const { toast } = useToast();

  useEffect(() => {
    const loadMenus = async () => {
      const data = await fetchMenus();
      setMenus(data);
    };
    loadMenus();
  }, []);

  const form = useForm<MenuFormValues>({
    resolver: zodResolver(menuFormSchema),
    defaultValues: initialData || {
      name: "",
      url: "",
      orderNum: 0,
      parentId: null,
      icon: "",
    },
  });

  async function onSubmit(data: MenuFormValues) {
    try {
      if (initialData) {
        await updateMenu(initialData.id, data);
      } else {
        await createMenu(data);
      }
      router.push("/menus");
      router.refresh();
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>èœå•åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥èœå•åç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="url"
          render={({ field }) => (
            <FormItem>
              <FormLabel>URL</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥URL" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="orderNum"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æ’åºå·</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  placeholder="è¯·è¾“å…¥æ’åºå·"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value))}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="parentId"
          render={({ field }) => (
            <FormItem>
              <FormLabel>çˆ¶èœå•</FormLabel>
              <FormControl>
                <Select
                  onValueChange={field.onChange}
                  defaultValue={field.value!}
                  value={field.value!}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="é€‰æ‹©çˆ¶èœå•" />
                  </SelectTrigger>
                  <SelectContent>
                    {menus.map((menu) => (
                      <SelectItem key={menu.id} value={menu.id}>
                        {menu.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="icon"
          render={({ field }) => (
            <FormItem>
              <FormLabel>å›¾æ ‡</FormLabel>
              <FormControl>
                <Input
                  placeholder="è¯·è¾“å…¥å›¾æ ‡"
                  {...field}
                  value={field.value!}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}
```

- åˆ›å»ºæ–°å»ºé¡µé¢ï¼š /admin/{module}/new/page.tsx
- åˆ›å»ºç¼–è¾‘é¡µé¢ï¼š /admin/{module}/{id}/page.tsx
- åˆ›å»ºè¯¦æƒ…é¡µé¢ï¼š /admin/{module}/{id}/detail/page.tsx

================
File: docs/server-ui/page-list.md
================
# PageList ç»„ä»¶

PageList æ˜¯ä¸€ä¸ªç”¨äºå±•ç¤ºåˆ†é¡µåˆ—è¡¨æ•°æ®çš„ React ç»„ä»¶ã€‚å®ƒæä¾›äº†çµæ´»çš„æ•°æ®åŠ è½½ã€åˆ†é¡µå’Œæ¸²æŸ“é€‰é¡¹ã€‚

## å±æ€§

| å±æ€§         | ç±»å‹      | æè¿°                                              |
| ------------ | --------- | ------------------------------------------------- |
| searchParams | object    | å½“å‰çš„æœç´¢å‚æ•°å¯¹è±¡                                |
| queryParse   | object    | è‡ªå®šä¹‰æŸ¥è¯¢å‚æ•°è§£æå™¨ï¼Œé»˜è®¤ä½¿ç”¨ `pageSearchParams` |
| basePath     | string    | åŸºç¡€è·¯å¾„ï¼Œç”¨äºæ„å»ºåˆ†é¡µ URL                        |
| load         | function  | åŠ è½½æ•°æ®çš„å¼‚æ­¥å‡½æ•°                                |
| renderItem   | function  | æ¸²æŸ“æ¯ä¸ªåˆ—è¡¨é¡¹çš„å‡½æ•°                              |
| empty        | ReactNode | è‡ªå®šä¹‰ç©ºçŠ¶æ€ç»„ä»¶                                  |
| emptyMessage | string    | ç©ºçŠ¶æ€æ˜¾ç¤ºçš„æ¶ˆæ¯                                  |
| onDelete     | function  | åˆ é™¤é¡¹ç›®çš„å›è°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼‰                        |

## ä½¿ç”¨ç¤ºä¾‹

```tsx
import PageList from "@/components/PageList";
import { UserCard } from "@/components/UserCard";

export default function UsersPage({ searchParams }) {
  return (
    <PageList<User>
      searchParams={searchParams}
      basePath="/users"
      load={async (params) => {
        const response = await fetch(
          `/api/users?page=${params.page}&pageSize=${params.pageSize}`
        );
        return await response.json();
      }}
      renderItem={(user, index) => <UserCard key={user.id} user={user} />}
      emptyMessage="æš‚æ— ç”¨æˆ·æ•°æ®"
    />
  );
}
```

## è¯´æ˜

1. ç»„ä»¶ä¼šè‡ªåŠ¨å¤„ç†åˆ†é¡µé€»è¾‘ï¼ŒåŒ…æ‹¬ URL å‚æ•°çš„æ›´æ–°ã€‚
2. å¯ä»¥é€šè¿‡ `queryParse` å±æ€§è‡ªå®šä¹‰æŸ¥è¯¢å‚æ•°çš„è§£ææ–¹å¼ã€‚
3. `load` å‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªåŒ…å« `data` å’Œ `total` çš„å¯¹è±¡ã€‚
4. ç»„ä»¶å†…ç½®äº†ç©ºçŠ¶æ€çš„å±•ç¤ºï¼Œå¯ä»¥é€šè¿‡ `empty` å’Œ `emptyMessage` å±æ€§è‡ªå®šä¹‰ã€‚
5. åˆ†é¡µæ§ä»¶ä½¿ç”¨äº† `SmartPagination` ç»„ä»¶ï¼Œæ”¯æŒæ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡ã€‚

é€šè¿‡ä½¿ç”¨ PageList ç»„ä»¶ï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºå…·æœ‰åˆ†é¡µåŠŸèƒ½çš„åˆ—è¡¨é¡µé¢ï¼Œå‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚

================
File: docs/server-ui/page-table.md
================
# PageTable ç»„ä»¶

PageTable æ˜¯ä¸€ä¸ªé€šç”¨çš„åˆ†é¡µè¡¨æ ¼ç»„ä»¶ï¼Œç”¨äºå±•ç¤ºå’Œç®¡ç†åˆ†é¡µæ•°æ®ã€‚å®ƒå°è£…äº†æ•°æ®åŠ è½½ã€åˆ†é¡µé€»è¾‘å’Œ UI æ¸²æŸ“ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•æ˜“ç”¨çš„æ¥å£æ¥åˆ›å»ºå¯å®šåˆ¶çš„æ•°æ®è¡¨æ ¼ã€‚

## å±æ€§

| å±æ€§å          | ç±»å‹                                                                     | æè¿°                                              |
| --------------- | ------------------------------------------------------------------------ | ------------------------------------------------- |
| searchParams    | `SearchParams`                                                           | å½“å‰é¡µé¢çš„æœç´¢å‚æ•°                                |
| queryParse      | `T`                                                                      | è‡ªå®šä¹‰æŸ¥è¯¢å‚æ•°è§£æå™¨ï¼Œé»˜è®¤ä½¿ç”¨ `pageSearchParams` |
| load            | `(params: inferParserType<T>) => Promise<{ data: D[]; total: number; }>` | åŠ è½½æ•°æ®çš„å¼‚æ­¥å‡½æ•°                                |
| columns         | `ColumnDef<D>[]`                                                         | è¡¨æ ¼åˆ—å®šä¹‰                                        |
| basePath        | `string`                                                                 | åŸºç¡€è·¯å¾„ï¼Œç”¨äºæ„å»ºåˆ†é¡µ URL                        |
| pageSizeOptions | `number[]`                                                               | å¯é€‰çš„æ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰é¡¹ï¼Œé»˜è®¤ä¸º `[10, 20, 30, 50]` |

## ä½¿ç”¨ç¤ºä¾‹

```tsx
import PageTable from "@/components/PageTable";
import { ColumnDef } from "@/components/shared/data-table";

// å®šä¹‰æ•°æ®ç±»å‹
interface User {
  id: string;
  name: string;
  email: string;
}

// å®šä¹‰åˆ—
const columns: ColumnDef<User>[] = [
  {
    accessorKey: "name",
    header: "å§“å",
  },
  {
    accessorKey: "email",
    header: "é‚®ç®±",
  },
];

// åœ¨é¡µé¢ç»„ä»¶ä¸­ä½¿ç”¨
export default function UsersPage({ searchParams }) {
  return (
    <PageTable<User>
      searchParams={searchParams}
      basePath="/users"
      columns={columns}
      load={async (params) => {
        // å®ç°æ•°æ®åŠ è½½é€»è¾‘
        const response = await fetch(
          `/api/users?page=${params.page}&pageSize=${params.pageSize}`
        );
        const { data, total } = await response.json();
        return { data, total };
      }}
    />
  );
}
```

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ PageTable ç»„ä»¶æ¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·åˆ—è¡¨é¡µé¢ã€‚ç»„ä»¶ä¼šè‡ªåŠ¨å¤„ç†åˆ†é¡µã€æ•°æ®åŠ è½½å’Œè¡¨æ ¼æ¸²æŸ“ï¼Œå¤§å¤§ç®€åŒ–äº†å¼€å‘è¿‡ç¨‹ã€‚

================
File: docs/shared-ui/smart-pagination.md
================
# SmartPagination ç»„ä»¶

SmartPagination æ˜¯ä¸€ä¸ªçµæ´»çš„åˆ†é¡µç»„ä»¶ï¼Œæä¾›äº†è‡ªå®šä¹‰é€‰é¡¹å’Œé¡µé¢å¤§å°æ›´æ”¹åŠŸèƒ½ã€‚

## ä½¿ç”¨åœºæ™¯

è¯¥ç»„ä»¶é€‚ç”¨äºéœ€è¦åˆ†é¡µåŠŸèƒ½çš„åˆ—è¡¨æˆ–è¡¨æ ¼å±•ç¤ºï¼Œç‰¹åˆ«æ˜¯åœ¨æ•°æ®é‡è¾ƒå¤§æ—¶ã€‚å®ƒå…è®¸ç”¨æˆ·è½»æ¾åœ°åœ¨ä¸åŒé¡µé¢é—´å¯¼èˆªï¼Œå¹¶å¯é€‰æ‹©æ¯é¡µæ˜¾ç¤ºçš„é¡¹ç›®æ•°é‡ã€‚

## ä½¿ç”¨ç¤ºä¾‹

```jsx
import { SmartPagination } from "@/components/shared/smart-pagination";

function MyComponent() {
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(10);
  const total = 100;

  return (
    <SmartPagination
      page={page}
      pageSize={pageSize}
      total={total}
      onChange={setPage}
      onChangePageSize={setPageSize}
      showSizeChanger={true}
    />
  );
}
```

## å±æ€§

| å±æ€§å           | ç±»å‹                                    | é»˜è®¤å€¼           | æè¿°                                     |
| ---------------- | --------------------------------------- | ---------------- | ---------------------------------------- |
| page             | number                                  | -                | å½“å‰é¡µç ï¼ˆå¿…å¡«ï¼‰                         |
| pageSize         | number                                  | -                | æ¯é¡µé¡¹ç›®æ•°ï¼ˆå¿…å¡«ï¼‰                       |
| total            | number                                  | -                | æ€»é¡¹ç›®æ•°ï¼ˆå¿…å¡«ï¼‰                         |
| onPrev           | () => void                              | -                | ä¸Šä¸€é¡µå›è°ƒå‡½æ•°ï¼ˆä¼šå…ˆè§¦å‘onChangeï¼‰       |
| onNext           | () => void                              | -                | ä¸‹ä¸€é¡µå›è°ƒå‡½æ•°ï¼ˆä¼šå…ˆè§¦å‘onChangeï¼‰       |
| onChange         | (page: number,pageSize: number) => void | -                | é¡µç å˜åŒ–å›è°ƒå‡½æ•°                         |
| onChangePageSize | (pageSize: number) => void              | -                | æ¯é¡µé¡¹ç›®æ•°å˜åŒ–å›è°ƒå‡½æ•°(ä¼šå…ˆè§¦å‘onChange) |
| pageSizeOptions  | number[]                                | [10, 20, 30, 50] | å¯é€‰çš„æ¯é¡µé¡¹ç›®æ•°                         |
| showSizeChanger  | boolean                                 | false            | æ˜¯å¦æ˜¾ç¤ºæ¯é¡µé¡¹ç›®æ•°é€‰æ‹©å™¨                 |
| className        | string                                  | -                | é¢å¤–çš„ CSS ç±»å                          |
| style            | React.CSSProperties                     | -                | å†…è”æ ·å¼                                 |
| ref              | React.Ref<HTMLDivElement>               | -                | Ref å¼•ç”¨                                 |

## æ³¨æ„äº‹é¡¹

- ç¡®ä¿ä¸ºå¿…å¡«å±æ€§ï¼ˆpage, pageSize, totalï¼‰æä¾›æ­£ç¡®çš„å€¼ã€‚
- å¦‚æœéœ€è¦è‡ªå®šä¹‰é¡µç å˜åŒ–æˆ–é¡µé¢å¤§å°å˜åŒ–çš„è¡Œä¸ºï¼Œè¯·æä¾›ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼ˆonChange, onChangePageSizeï¼‰ã€‚
- è®¾ç½® `showSizeChanger` ä¸º true å¯å¯ç”¨æ¯é¡µé¡¹ç›®æ•°é€‰æ‹©åŠŸèƒ½ã€‚
- ç»„ä»¶ä¼šæ ¹æ®æ€»é¡µæ•°è‡ªåŠ¨è°ƒæ•´é¡µç æ˜¾ç¤ºé€»è¾‘ï¼Œç¡®ä¿è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

================
File: eslint.config.mjs
================
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends(
    "next/core-web-vitals",
    "next/typescript",
    "prettier" 
  ),
  {
    rules: {
      "@typescript-eslint/no-unused-vars": ["error", { 
        "args": "all",
        "argsIgnorePattern": "^_",
        "caughtErrors": "all",
        "caughtErrorsIgnorePattern": "^_",
        "destructuredArrayIgnorePattern": "^_",
        "varsIgnorePattern": "^_",
        "ignoreRestSiblings": true
      }],
      "no-console": ["warn", { allow: ["warn", "error"] }],
      "no-multiple-empty-lines": ["error", { max: 1, maxEOF: 0 }],
      "no-trailing-spaces": "error",
    }
  }
];

export default eslintConfig;

================
File: global.d.ts
================
export {}; // æ˜¾å¼å°†æ–‡ä»¶æ ‡è®°ä¸ºæ¨¡å—
import { Prisma } from "@prisma/client";

declare global {
  // you can use typical basic types
  // or you can use classes, interfaces, object types, etc.
  namespace PrismaJson {
    type StringArray = string[] | null;
  }
  type PageableQuery<T> = {
    page: number;
    pageSize: number;
    where?: Prisma.Args<T, "findMany">["where"];
    orderBy?: Prisma.Args<T, "findMany">["orderBy"];
    include?: Prisma.Args<T, "findMany">["include"];
  };
}

================
File: next.config.ts
================
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "*",
        port: "",
        pathname: "/**",
      },
      {
        protocol: "http",
        hostname: "*",
        port: "",
        pathname: "/**",
      },
    ],
  },
};

export default nextConfig;

================
File: package.json
================
{
  "name": "coze-webhook-admin",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "db:push": "prisma db push",
    "db:reset": "prisma db reset",
    "db:migrate": "prisma migrate dev --name init",
    "db:generate": "prisma generate",
    "db:studio": "prisma studio",
    "repomix": "repomix",
    "ui:add": "pnpm dlx shadcn@latest add"
  },
  "dependencies": {
    "@conform-to/react": "^1.2.2",
    "@conform-to/zod": "^1.2.2",
    "@hookform/resolvers": "^3.9.1",
    "@prisma/client": "6.2.1",
    "@radix-ui/react-accordion": "^1.2.2",
    "@radix-ui/react-alert-dialog": "^1.1.4",
    "@radix-ui/react-avatar": "^1.1.2",
    "@radix-ui/react-checkbox": "^1.1.3",
    "@radix-ui/react-dialog": "^1.1.4",
    "@radix-ui/react-dropdown-menu": "^2.1.4",
    "@radix-ui/react-label": "^2.1.1",
    "@radix-ui/react-scroll-area": "^1.2.2",
    "@radix-ui/react-select": "^2.1.4",
    "@radix-ui/react-separator": "^1.1.1",
    "@radix-ui/react-slot": "^1.1.1",
    "@radix-ui/react-switch": "^1.1.2",
    "@radix-ui/react-tabs": "^1.1.2",
    "@radix-ui/react-toast": "^1.2.4",
    "@radix-ui/react-tooltip": "^1.1.6",
    "@tanstack/react-table": "^8.20.6",
    "@types/json-bigint": "^1.0.4",
    "bcrypt": "^5.1.1",
    "chart.js": "^4.4.7",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "1.0.0",
    "date-fns": "^4.1.0",
    "elysia": "^1.2.9",
    "framer-motion": "^11.15.0",
    "lucide-react": "^0.469.0",
    "next": "15.1.3",
    "next-auth": "5.0.0-beta.25",
    "next-logger": "^5.0.1",
    "next-themes": "^0.4.4",
    "nuqs": "^2.3.0",
    "pino": "^9.6.0",
    "prisma": "^6.2.1",
    "prisma-json-types-generator": "^3.2.2",
    "react": "^19.0.0",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^19.0.0",
    "react-hook-form": "^7.54.2",
    "recharts": "^2.15.0",
    "repomix": "^0.2.17",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "text-search-engine": "^1.4.2",
    "uuid": "^11.0.3",
    "vaul": "^1.1.2",
    "zod": "^3.24.1",
    "zod-to-json-schema": "^3.24.1"
  },
  "devDependencies": {
    "@elysiajs/swagger": "^1.2.0",
    "@eslint/eslintrc": "^3",
    "@types/bcrypt": "^5.0.2",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.0.1",
    "eslint": "^9",
    "eslint-config-next": "15.1.3",
    "eslint-config-prettier": "^9.1.0",
    "postcss": "^8",
    "prettier": "^3.1.1",
    "prettier-plugin-tailwindcss": "^0.5.9",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  },
  "pnpm": {
    "patchedDependencies": {
      "@elysiajs/swagger@1.2.0": "patches/@elysiajs__swagger@1.2.0.patch"
    }
  }
}

================
File: patches/@elysiajs__swagger@1.2.0.patch
================
diff --git a/dist/index.mjs b/dist/index.mjs
index f46ea5afe65e99731f941ac66ccdb8aea0fa5adf..13a2b203b61e0dcead6e7577b6ff915da907237c 100644
--- a/dist/index.mjs
+++ b/dist/index.mjs
@@ -426,7 +426,7 @@ var swagger = async ({
   const app = new Elysia({ name: "@elysiajs/swagger" });
   app.get(path, function documentation2() {
     const combinedSwaggerOptions = {
-      url: `/${relativePath}/json`,
+      url: `${relativePath}/json`,
       dom_id: "#swagger-ui",
       ...swaggerOptions
     };
@@ -440,7 +440,7 @@ var swagger = async ({
     const scalarConfiguration = {
       spec: {
         ...scalarConfig.spec,
-        url: `/${relativePath}/json`
+        url: `${relativePath}/json`
       },
       ...scalarConfig,
       // so we can showcase the elysia theme

================
File: postcss.config.mjs
================
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;

================
File: prettier.config.mjs
================
/** @type {import('prettier').Config} */
export default {
  endOfLine: "lf",
  semi: true,
  singleQuote: false,
  tabWidth: 2,
  trailingComma: "es5",
  importOrder: [
    "^(react/(.*)$)|^(react$)",
    "^(next/(.*)$)|^(next$)",
    "<THIRD_PARTY_MODULES>",
    "",
    "^types$",
    "^@/types/(.*)$",
    "^@/config/(.*)$",
    "^@/lib/(.*)$",
    "^@/hooks/(.*)$",
    "^@/components/ui/(.*)$",
    "^@/components/(.*)$",
    "^@/styles/(.*)$",
    "^@/app/(.*)$",
    "",
    "^[./]",
  ],
  importOrderSeparation: false,
  importOrderSortSpecifiers: true,
  importOrderBuiltinModulesToTop: true,
  importOrderParserPlugins: ["typescript", "jsx", "decorators-legacy"],
  importOrderMergeDuplicateImports: true,
  importOrderCombineTypeAndValueImports: true,
  plugins: ["prettier-plugin-tailwindcss"],
};

================
File: prisma/schema.prisma
================
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator json {
  provider = "prisma-json-types-generator"
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  type      String   @default("ADMIN") // è§’è‰²ç±»å‹: superadmin(è¶…çº§ç®¡ç†å‘˜), admin(ç®¡ç†å‘˜)
  nickname  String?
  avatar    String?
  phone     String?  @unique
  role      Role?    @relation(fields: [roleId], references: [id])
  roleId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  code        String       @unique // è§’è‰²ç¼–ç ,ç”¨äºç¨‹åºä¸­è¯†åˆ«
  type        String       @default("CUSTOM") // è§’è‰²ç±»å‹: SYSTEM(ç³»ç»Ÿå†…ç½®), CUSTOM(è‡ªå®šä¹‰)
  status      String       @default("ACTIVE") // çŠ¶æ€: ACTIVE, DISABLED
  description String?
  permissions Permission[]
  admins      Admin[]
  isDefault   Boolean      @default(false) // æ˜¯å¦ä¸ºé»˜è®¤è§’è‰²
  sort        Int          @default(0) // æ’åº
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          String       @id @default(cuid())
  name        String       @unique
  key         String       @unique // æƒé™æ ‡è¯†ç¬¦
  description String?
  parentId    String?
  parent      Permission?  @relation("ParentChild", fields: [parentId], references: [id])
  children    Permission[] @relation("ParentChild")
  roles       Role[]
  menus       Menu[]
  sort        Int          @default(0) // æ’åº
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Menu {
  id          String       @id @default(cuid())
  name        String
  parentId    String? // çˆ¶èœå•ID
  sort        Int          @default(0) // æ’åº
  url         String // å‰ç«¯é¡µé¢è·¯ç”±åœ°å€æˆ–æ¥å£åœ°å€
  permissions Permission[]
  icon        String? // èœå•å›¾æ ‡
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model CozeWebhook {
  id            String        @id @default(cuid())
  name          String
  url           String
  authorization String
  apiEndpoints  ApiEndpoint[]
  logs          ApiEndpointLog[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ApiEndpoint {
  id             String           @id @default(cuid())
  cozeWebhook    CozeWebhook      @relation(fields: [cozeWebhookId], references: [id])
  cozeWebhookId  String
  type           String           // openaiLike or request
  name           String
  description    String?
  apiKeys        ApiKey[]
  logs           ApiEndpointLog[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model ApiKey {
  id            String        @id @default(cuid())
  key           String        @unique
  apiEndpoints  ApiEndpoint[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ApiEndpointLog {
  id              String      @id @default(cuid())
  apiEndpoint     ApiEndpoint @relation(fields: [apiEndpointId], references: [id])
  apiEndpointId   String
  cozeWebhook     CozeWebhook @relation(fields: [cozeWebhookId], references: [id])
  ip              String?
  cozeWebhookId   String
  requestParams   String      // JSON string of request parameters
  response        String?      // JSON string of response
  duration        Int?         // Duration in milliseconds
  apiKey          String?      // The API key used for this request
  createdAt       DateTime    @default(now())
}

================
File: README.MD
================
# **é¡¹ç›®åç§°**

> COZEæœåŠ¡

---

## ğŸŒŸ **é¡¹ç›®ç®€ä»‹**

è¿™æ˜¯ä¸€ä¸ªç”¨äº **[é¡¹ç›®æ ¸å¿ƒåŠŸèƒ½]** çš„å¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…é€šè¿‡ **[ç®€çŸ­åŠŸèƒ½æè¿°]** æ¥ç®€åŒ–ä»–ä»¬çš„å¼€å‘æµç¨‹ã€‚é¡¹ç›®åŸºäº **[æŠ€æœ¯æ ˆ]**ï¼Œå¹¶æ”¯æŒ **[å…¶ä»–å…³é”®åŠŸèƒ½]**ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯ç»éªŒä¸°å¯Œçš„å¼€å‘è€…ï¼Œéƒ½å¯ä»¥è½»æ¾ä¸Šæ‰‹å¹¶è´¡çŒ®ã€‚

ğŸ”§ **ä¸»è¦åŠŸèƒ½ï¼š**

- åŠŸèƒ½ 1
- åŠŸèƒ½ 2
- åŠŸèƒ½ 3
- æ›´å¤š...

---

## ğŸ› ï¸ **æŠ€æœ¯æ ˆ**

æœ¬é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯æ„å»ºï¼š

- **React 19** - ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“
- **Next.js 15** - ç”¨äºæ„å»ºå¿«é€Ÿã€ä¼˜åŒ–çš„ Web åº”ç”¨æ¡†æ¶
- **TypeScript** - æä¾›é™æ€ç±»å‹æ£€æŸ¥
- **Prisma** - ç”¨äºä¸æ•°æ®åº“è¿›è¡Œäº¤äº’
- **Tailwind CSS** - ç”¨äºå¿«é€Ÿæ„å»ºå“åº”å¼ç”¨æˆ·ç•Œé¢çš„ CSS æ¡†æ¶

---

## ğŸ“¦ **å®‰è£…ä¸ä½¿ç”¨**

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/username/project-name.git
cd project-name
```

### 2. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 3. å¯åŠ¨å¼€å‘ç¯å¢ƒ

```bash
pnpm dev
```

è¿™å°†å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ï¼Œé€šå¸¸åœ¨ `http://localhost:3000` ä¸Šå¯ä»¥è®¿é—®ä½ çš„åº”ç”¨ã€‚

---

## ğŸ› ï¸ **é…ç½®**

### é…ç½®æ–‡ä»¶

- é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`/config/`
- æ”¯æŒçš„é…ç½®é¡¹ï¼š
  - **API_URL**: è®¾ç½®ä½ çš„ API æœåŠ¡ç«¯åœ°å€ã€‚
  - **ENV_MODE**: è®¾ç½®å¼€å‘æˆ–ç”Ÿäº§æ¨¡å¼ã€‚

---

## ğŸš€ **åŠŸèƒ½æ¨¡å—**

### ğŸŒ **æ¨¡å— 1ï¼šç”¨æˆ·ç™»å½•ä¸æƒé™ç®¡ç†**

- æ”¯æŒåŸºäº **RBAC** çš„æƒé™ç®¡ç†ã€‚
- é›†æˆ **Next-Auth** æä¾›çµæ´»çš„è®¤è¯æ–¹æ¡ˆã€‚
- æ”¯æŒå¾®ä¿¡ç™»å½•ã€äºŒç»´ç å±•ç¤ºå’ŒéªŒè¯ç ç®¡ç†ã€‚

### ğŸ“‚ **æ¨¡å— 2ï¼šæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ**

- æ”¯æŒ S3ã€æœ¬åœ°å­˜å‚¨ç­‰ä¸åŒå­˜å‚¨ç±»å‹ã€‚
- æ¯ä¸ªæ–‡ä»¶å¯¹åº”å­˜å‚¨ç±»å‹ï¼Œå¹¶ä¸”æä¾›æ“ä½œæ¥å£ã€‚

### ğŸ“Š **æ¨¡å— 3ï¼šè®¢å•ä¸åº“å­˜ç®¡ç†**

- ä½¿ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰å¯¹è®¢å•ã€åº“å­˜è¿›è¡Œé«˜æ•ˆç®¡ç†ã€‚
- æ”¯æŒå¤æ‚çš„ SKU é€‰æ‹©é€»è¾‘å’Œåº“å­˜è®¡ç®—ã€‚

---

## ğŸ¯ **è´¡çŒ®æŒ‡å—**

1. **Fork** æœ¬ä»“åº“å¹¶åˆ›å»ºä½ çš„ç‰¹æ€§åˆ†æ”¯ï¼š

   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **æäº¤** ä»£ç ï¼š

   ```bash
   git commit -am 'Add your feature'
   ```

3. **æ¨é€** åˆ°è¿œç¨‹ä»“åº“ï¼š

   ```bash
   git push origin feature/your-feature-name
   ```

4. æäº¤ **Pull Request** è¿›è¡Œä»£ç å®¡æŸ¥ã€‚

---

## ğŸ§ª **æµ‹è¯•**

æœ¬é¡¹ç›®é‡‡ç”¨ **æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰** æ¨¡å¼ï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½æ‹¥æœ‰å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿é«˜è´¨é‡ä»£ç ã€‚

- æµ‹è¯•æ¡†æ¶ï¼š**Jest** + **React Testing Library**
- è¿è¡Œæµ‹è¯•ï¼š
  ```bash
  pnpm test
  ```

---

## ğŸ”§ **éƒ¨ç½²**

### éƒ¨ç½²åˆ° Docker

é¡¹ç›®å·²ç»é…ç½®å¥½äº† Docker æ”¯æŒï¼Œå¯ä»¥è½»æ¾åœ°åœ¨å®¹å™¨ä¸­è¿è¡Œï¼š

1. æ„å»ºé•œåƒï¼š

   ```bash
   docker build -t project-name .
   ```

2. è¿è¡Œå®¹å™¨ï¼š
   ```bash
   docker run -p 3000:3000 project-name
   ```

---

## ğŸ“„ **è®¸å¯è¯**

æœ¬é¡¹ç›®ä½¿ç”¨ [MIT License](LICENSE) è¿›è¡Œæˆæƒã€‚ä½ å¯ä»¥è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å¹¶åˆ†å‘ä»£ç ï¼Œä½†è¯·ä¿ç•™ç‰ˆæƒå£°æ˜ã€‚

---

## ğŸ“ **è”ç³»æ–¹å¼**

- ä½œè€…ï¼š**[ä½ çš„åå­—]**
- é‚®ç®±ï¼š[your-email@example.com](mailto:your-email@example.com)
- GitHubï¼š[https://github.com/username](https://github.com/username)
- å…¶ä»–è”ç³»æ–¹å¼ï¼š[Twitter](https://twitter.com/yourusername)

---

## ğŸ‰ **è‡´è°¢**

æ„Ÿè°¢ä»¥ä¸‹é¡¹ç›®å’Œè´¡çŒ®è€…æä¾›çš„æ”¯æŒï¼š

- [Next.js](https://nextjs.org)
- [React](https://reactjs.org)
- [Prisma](https://www.prisma.io)
- [Tailwind CSS](https://tailwindcss.com)

---

## ğŸ“ˆ **é¡¹ç›®å‘å±•è§„åˆ’**

- **v1.0.0**ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¸Šä¼ ã€æƒé™ç®¡ç†ã€è®¢å•ç®¡ç†ã€‚
- **v1.1.0**ï¼šæ”¯æŒå¤šå­˜å‚¨ç±»å‹ã€æ›´ç²¾ç¡®çš„åº“å­˜è®¡ç®—ã€‚
- **æœªæ¥ç‰ˆæœ¬**ï¼šé›†æˆæ›´å¤šç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚æ”¯ä»˜ã€é€šçŸ¥ç­‰ï¼‰ã€‚

---

ğŸ‘¨â€ğŸ’» **æ¬¢è¿ä½ çš„åŠ å…¥**ï¼Œä¸€åŒæ¨åŠ¨é¡¹ç›®çš„è¿›ä¸€æ­¥å‘å±•ï¼ğŸ’¡

================
File: repomix.config.json
================
{
  "output": {
    "filePath": "repomix-output.txt",
    "style": "plain",
    "fileSummary": true,
    "directoryStructure": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "copyToClipboard": false
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  }
}

================
File: src/api/index.ts
================
import swagger from "@elysiajs/swagger";
import { Elysia, ValidationError } from "elysia";

const app = new Elysia({ prefix: "/api" });
app.onError({ as: "global" }, ({ code, error }) => {
  if (code === "VALIDATION" && error instanceof ValidationError) {
    return { error: error.all?.map((z) => z.summary).join(","), code };
  }
  return Response.json(
    { error: error.toString(), code },
    {
      status: 500,
    }
  );
});
app.use(swagger({ path: "/swagger" }));

export type TElysiaApp = typeof app;

export { app };

================
File: src/api/lib/json.bigint.ts
================
import Elysia from "elysia";

export function JSONBigInt({ response }: { response: unknown }) {
  if (response instanceof Response) {
    return response;
  }

  if (typeof response === "object" && response !== null) {
    return new Response(
      JSON.stringify(response, (_, v) =>
        typeof v === "bigint" ? Number(v.toString()) : v
      ),
      {
        headers: {
          "Content-Type": `application/json; charset=utf-8`,
        },
      }
    );
  }
}

export function jsonBigInt() {
  return new Elysia({ name: "jsonBigInt" }).mapResponse(
    { as: "global" },
    JSONBigInt
  );
  // .onBeforeHandle({ as: "global" }, ({ body }) => {
  //   console.log("body", body);
  // });
}

================
File: src/api/middlewares/auth.ts
================
import { auth as nextjsAuth } from "@/lib/auth";
import Elysia from "elysia";
import type { Session } from "next-auth";

/** è®¤è¯æ•°æ® */
export type AuthData = {
  Auth: {
    /** ä¼šè¯ç”¨æˆ· */
    user: Session["user"];
  };
};

/**
 * æˆæƒä¿¡æ¯
 * @returns
 */
export function auth() {
  return new Elysia({ name: "Service.Auth" })
    .derive({ as: "scoped" }, async () => {
      const user = await nextjsAuth();
      return { Auth: { user: user?.user } };
    })
    .onBeforeHandle({ as: "scoped" }, ({ Auth, error }) => {
      if (!Auth?.user || !Auth.user) return error(401);
    });
}

================
File: src/app/admin/admins/_components/admin-form.tsx
================
"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";
import { createAdmin, updateAdmin } from "../actions";
import { Admin } from "@prisma/client";
import { ADMIN_ROLE } from "@/service/enum/ADMIN_ROLE";

const formSchema = z.object({
  email: z.string().email({ message: "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€" }),
  username: z.string().min(2, { message: "ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦" }),
  password: z.string().min(6, { message: "å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦" }).optional(),
  phone: z.string().optional(),
  nickname: z.string().optional(),
});

export default function AdminForm({ admin }: { admin?: Admin }) {
  const router = useRouter();
  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      email: admin?.email || "",
      username: admin?.username || "",
      nickname: admin?.nickname || "",
    },
  });

  async function onSubmit(values: z.infer<typeof formSchema>) {
    try {
      if (admin) {
        await updateAdmin(admin.id, {
          ...values,
          role: values.role as ADMIN_ROLE,
        });
      } else {
        await createAdmin({
          ...values,
          password: values.password || "123456",
          role: values.role as ADMIN_ROLE,
        });
      }
      router.push("/admins");
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : "æ“ä½œå¤±è´¥");
    }
  }

  return (
    <Form {...form}>
      <form
        onSubmit={form.handleSubmit(onSubmit)}
        className="w-[400px] space-y-8"
      >
        <FormField
          control={form.control}
          name="email"
          render={({ field }) => (
            <FormItem>
              <FormLabel>é‚®ç®±</FormLabel>
              <FormControl>
                <Input {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="username"
          render={({ field }) => (
            <FormItem>
              <FormLabel>ç”¨æˆ·å</FormLabel>
              <FormControl>
                <Input {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        {!admin && (
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>å¯†ç </FormLabel>
                <FormControl>
                  <Input type="password" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        )}
        <FormField
          control={form.control}
          name="nickname"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æ˜µç§°</FormLabel>
              <FormControl>
                <Input {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="phone"
          render={({ field }) => (
            <FormItem>
              <FormLabel>ç”µè¯</FormLabel>
              <FormControl>
                <Input {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <Button type="submit">{admin ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/admins/[id]/loading.tsx
================
export { SkeletonForm as default } from "@/components/skeleton/form";

================
File: src/app/admin/admins/[id]/page.tsx
================
import { AdminService } from "@/service/admin.service";
import AdminForm from "../_components/admin-form";
import { notFound } from "next/navigation";

export default async function EditAdminPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const admin = await AdminService.getAdmin(id);
  if (!admin) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-6 text-2xl font-bold">ç¼–è¾‘ç®¡ç†å‘˜</h1>
      <AdminForm admin={admin} />
    </div>
  );
}

================
File: src/app/admin/admins/actions.ts
================
"use server";

import { AdminService } from "@/service/admin.service";
import { ADMIN_ROLE } from "@/service/enum/ADMIN_ROLE";
import { revalidatePath } from "next/cache";

export async function getAdmins(
  ...args: Parameters<typeof AdminService.getAdmins>
) {
  return AdminService.getAdmins(...args);
}

export async function resetPassword(adminId: string) {
  // è¿™é‡Œéœ€è¦åœ¨ AdminService ä¸­å®ç°é‡ç½®å¯†ç çš„æ–¹æ³•
  await AdminService.updateAdmin(adminId, { password: "admin" });
  revalidatePath("/admins");
  return { success: true };
}

export async function deleteAdmin(adminId: string) {
  await AdminService.deleteAdmin(adminId);
  revalidatePath("/admins");
  return { success: true };
}

export async function createAdmin(data: {
  email: string;
  password: string;
  username: string;
  nickname?: string;
  phone?: string;
  role?: ADMIN_ROLE;
}) {
  await AdminService.createAdmin(data.email, data.username, data.password, {
    nickname: data.nickname,
    role: data.role,
    phone: data.phone,
  });
  revalidatePath("/admins");
  return { success: true };
}

export async function updateAdmin(
  adminId: string,
  data: {
    email?: string;
    password?: string;
    username?: string;
    nickname?: string;
    phone?: string;
    role?: ADMIN_ROLE;
  }
) {
  await AdminService.updateAdmin(adminId, data);
  revalidatePath("/admins");
  return { success: true };
}

================
File: src/app/admin/admins/columns.tsx
================
"use client";
import { ColumnDef } from "@tanstack/react-table";
import { Admin } from "@prisma/client";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Key, Edit, Trash } from "lucide-react";
import { resetPassword, deleteAdmin } from "./actions";
import Link from "next/link";
import { format } from "date-fns";
import { ADMIN_ROLE, ADMIN_ROLE_NAME } from "@/service/enum/ADMIN_ROLE";
import { useToast } from "@/hooks/use-toast";

const AdminActions = ({ admin }: { admin: Admin }) => {
  const { toast } = useToast();
  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="h-8 w-8 p-0">
          <span className="sr-only">æ‰“å¼€èœå•</span>
          <MoreHorizontal className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem
          onClick={async () => {
            if (confirm("ç¡®å®šè¦é‡ç½®å¯†ç å—ï¼Ÿ")) {
              await resetPassword(admin.id);
              alert("å¯†ç å·²é‡ç½®");
            }
          }}
        >
          <Key className="mr-2 h-4 w-4" />
          é‡ç½®å¯†ç 
        </DropdownMenuItem>
        <Link href={`/admins/${admin.id}`}>
          <DropdownMenuItem>
            <Edit className="mr-2 h-4 w-4" />
            ç¼–è¾‘ä¿¡æ¯
          </DropdownMenuItem>
        </Link>
        <DropdownMenuItem
          onClick={async () => {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¯¥ç®¡ç†å‘˜å—ï¼Ÿ")) {
              try {
                await deleteAdmin(admin.id);
                toast({ description: "ç®¡ç†å‘˜å·²åˆ é™¤" });
              } catch (error) {
                toast({
                  description:
                    error instanceof Error ? error.message : "åˆ é™¤ç®¡ç†å‘˜å¤±è´¥",
                  variant: "destructive",
                });
              }
            }
          }}
          className="text-red-600"
        >
          <Trash className="mr-2 h-4 w-4" />
          åˆ é™¤ç®¡ç†å‘˜
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
};

export const columns: ColumnDef<Admin>[] = [
  {
    accessorKey: "avatar",
    header: "å¤´åƒ",
    cell: ({ row }) => {
      const admin = row.original;
      return (
        <Avatar>
          <AvatarImage src={admin.avatar || ""} alt={admin.email || ""} />
          <AvatarFallback>{admin.email?.[0] || admin.email[0]}</AvatarFallback>
        </Avatar>
      );
    },
  },
  {
    accessorKey: "email",
    header: "é‚®ç®±",
  },
  {
    accessorKey: "username",
    header: "ç”¨æˆ·å",
  },
  {
    accessorKey: "nickname",
    header: "æ˜µç§°",
  },
  {
    accessorKey: "phone",
    header: "ç”µè¯",
  },
  {
    accessorKey: "role",
    header: "è§’è‰²",
    cell: ({ row }) => {
      const admin = row.original;
      return ADMIN_ROLE_NAME[admin.role as ADMIN_ROLE];
    },
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return format(new Date(row.original.createdAt), "yyyy-MM-dd HH:mm:ss");
    },
  },
  {
    id: "actions",
    cell: ({ row }) => <AdminActions admin={row.original} />,
  },
];

================
File: src/app/admin/admins/new/loading.tsx
================
export { SkeletonForm as default } from "@/components/skeleton/form";

================
File: src/app/admin/admins/new/page.tsx
================
import AdminForm from "../_components/admin-form";

export default function NewAdminPage() {
  return (
    <div className="container mx-auto py-10">
      <h1 className="text-2xl font-bold mb-6">æ–°å»ºç®¡ç†å‘˜</h1>
      <AdminForm />
    </div>
  );
}

================
File: src/app/admin/admins/page.tsx
================
import { getAdmins } from "./actions";
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";

export default async function AdminsPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">ç®¡ç†å‘˜ç®¡ç†</h1>
        <Link href="/admins/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºç®¡ç†å‘˜
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/admins"
        load={(data) =>
          getAdmins({
            page: data.page,
            pageSize: data.pageSize,
            where: data.keyword
              ? {
                  OR: [
                    { email: { contains: data.keyword } },
                    { username: { contains: data.keyword } },
                    { nickname: { contains: data.keyword } },
                  ],
                }
              : {},
          })
        }
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/api-endpoints/_components/basic-info.tsx
================
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ApiEndpoint } from "@prisma/client";
import Link from "next/link";

interface BasicInfoProps {
  apiEndpoint: ApiEndpoint & {
    path: string;
    cozeWebhook: {
      name: string;
      url: string;
    };
  };
}

export function BasicInfo({ apiEndpoint }: BasicInfoProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>åŸºæœ¬ä¿¡æ¯</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <label className="font-medium">åç§°:</label>
          <p>{apiEndpoint.name}</p>
        </div>
        <div>
          <label className="font-medium">webhook:</label>
          <p>
            <Link
              className="text-blue-600 hover:underline"
              href={`/admin/webhooks/${apiEndpoint.cozeWebhookId}`}
            >
              {apiEndpoint.cozeWebhook?.name}
            </Link>
          </p>
        </div>
        <div>
          <label className="font-medium">æè¿°:</label>
          <p>{apiEndpoint.description}</p>
        </div>
        <div>
          <label className="font-medium">è·¯å¾„:</label>
          <p>{apiEndpoint.path}</p>
        </div>
        <div>
          <label className="font-medium">ç±»å‹:</label>
          <p>{apiEndpoint.type}</p>
        </div>
        <div>
          <label className="font-medium">åˆ›å»ºæ—¶é—´:</label>
          <p>{apiEndpoint.createdAt.toLocaleString()}</p>
        </div>
      </CardContent>
    </Card>
  );
}

================
File: src/app/admin/api-endpoints/_components/detail-tabs.tsx
================
import { Card, CardContent } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ApiEndpoint } from "@prisma/client";
import { KeysList } from "./keys-list";
import { RecordsList } from "./records-list";
import { Suspense } from "react";

interface DetailTabsProps {
  apiEndpoint: ApiEndpoint & {
    path: string;
  };
}

export function DetailTabs({ apiEndpoint }: DetailTabsProps) {
  return (
    <Tabs defaultValue="method" className="w-full">
      <TabsList className="grid w-full grid-cols-3">
        <TabsTrigger value="method">è°ƒç”¨æ–¹æ³•</TabsTrigger>
        <TabsTrigger value="records">è°ƒç”¨è®°å½•</TabsTrigger>
        <TabsTrigger value="keys">å¯ç”¨å¯†é’¥</TabsTrigger>
      </TabsList>
      <TabsContent value="method">
        <Card>
          <CardContent className="pt-6">
            {apiEndpoint.type === "openaiLike" && (
              <pre className="rounded bg-slate-950 p-4 text-sm text-slate-50">
                {`curl -X POST \\
${process.env.NEXT_PUBLIC_API_URL}${apiEndpoint.path} \\
-H "Content-Type: application/json" \\
-H "Authorization: Bearer <YOUR_API_KEY>" \\
-d '{
      "model": "${apiEndpoint.id}",
      "messages": [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Hello!"}
      ],
      "stream": false
    }'
`}
              </pre>
            )}
            {apiEndpoint.type === "request" && (
              <pre className="rounded bg-slate-950 p-4 text-sm text-slate-50">
                {`curl -X POST \\
${process.env.NEXT_PUBLIC_API_URL}${apiEndpoint.path} \\
-H "Content-Type: application/json" \\
-H "Authorization: Bearer <YOUR_API_KEY>" \\
-d '{ "foo": "bar" }'
`}
              </pre>
            )}
          </CardContent>
        </Card>
      </TabsContent>
      <TabsContent value="records">
        <Card>
          <CardContent className="pt-6">
            <Suspense fallback={<div>Loading...</div>}>
              <RecordsList endpointId={apiEndpoint.id} />
            </Suspense>
          </CardContent>
        </Card>
      </TabsContent>
      <TabsContent value="keys">
        <Card>
          <CardContent className="pt-6">
            <Suspense fallback={<div>Loading...</div>}>
              <KeysList endpointId={apiEndpoint.id} />
            </Suspense>
          </CardContent>
        </Card>
      </TabsContent>
    </Tabs>
  );
}

================
File: src/app/admin/api-endpoints/_components/form.tsx
================
"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";
import { ApiEndpoint, CozeWebhook } from "@prisma/client";
import { createApiEndpoint, updateApiEndpoint } from "../actions";
import { useToast } from "@/hooks/use-toast";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";

const apiEndpointFormSchema = z.object({
  name: z.string().min(1, "åç§°ä¸èƒ½ä¸ºç©º"),
  type: z.enum(["openaiLike", "request"], {
    required_error: "è¯·é€‰æ‹©ç±»å‹",
  }),
  description: z.string().optional(),
  cozeWebhookId: z.string().min(1, "è¯·é€‰æ‹©æ‰€å±Webhook"),
});

type ApiEndpointFormValues = z.infer<typeof apiEndpointFormSchema>;

interface ApiEndpointFormProps {
  initialData?: ApiEndpoint & {
    cozeWebhook: CozeWebhook;
  };
  webhookOptions: {
    id: string;
    url: string;
    name: string;
  }[];
}

export function ApiEndpointForm({
  initialData,
  webhookOptions,
}: ApiEndpointFormProps) {
  const router = useRouter();
  const { toast } = useToast();

  const form = useForm<ApiEndpointFormValues>({
    resolver: zodResolver(apiEndpointFormSchema),
    defaultValues: initialData
      ? {
          name: initialData.name,
          type: initialData.type as "openaiLike" | "request",
          description: initialData.description || "",
          cozeWebhookId: initialData.cozeWebhookId,
        }
      : {
          name: "",
          type: "request",
          description: "",
          cozeWebhookId: "",
        },
  });

  async function onSubmit(data: ApiEndpointFormValues) {
    try {
      if (initialData) {
        await updateApiEndpoint(initialData.id, data);
      } else {
        await createApiEndpoint(data);
      }
      router.push("/admin/api-endpoints");
      router.refresh();
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥APIç«¯ç‚¹åç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="type"
          render={({ field }) => (
            <FormItem>
              <FormLabel>ç±»å‹</FormLabel>
              <Select onValueChange={field.onChange} defaultValue={field.value}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="è¯·é€‰æ‹©ç±»å‹" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="openaiLike">OpenAIå…¼å®¹</SelectItem>
                  <SelectItem value="request">æ™®é€šè¯·æ±‚</SelectItem>
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æè¿°</FormLabel>
              <FormControl>
                <Textarea
                  placeholder="è¯·è¾“å…¥APIç«¯ç‚¹æè¿°"
                  className="resize-none"
                  {...field}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="cozeWebhookId"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æ‰€å±Webhook</FormLabel>
              <Select
                onValueChange={field.onChange}
                defaultValue={field.value}
                disabled={!!initialData}
              >
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="è¯·é€‰æ‹©æ‰€å±Webhook" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  {webhookOptions.map((webhook) => (
                    <SelectItem key={webhook.id} value={webhook.id}>
                      {webhook.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/api-endpoints/_components/keys-list.tsx
================
"use client";

import { ApiKey } from "@prisma/client";
import { DataTable } from "@/components/shared/data-table";
import { ColumnDef } from "@tanstack/react-table";
import { formatDateTime } from "@/lib/utils";
import { getEndpointKeys } from "../actions";
import { use, useEffect, useState } from "react";

interface KeysListProps {
  endpointId: string;
}

const columns: ColumnDef<ApiKey>[] = [
  {
    accessorKey: "key",
    header: "å¯†é’¥",
  },
  {
    accessorKey: "name",
    header: "åç§°",
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => formatDateTime(row.original.createdAt),
  },
  {
    accessorKey: "expiresAt",
    header: "è¿‡æœŸæ—¶é—´",
    // cell: ({ row }) =>
    //   row.original.expiresAt
    //     ? formatDateTime(row.original.expiresAt)
    //     : "æ°¸ä¸è¿‡æœŸ",
  },
];

export function KeysList({ endpointId }: KeysListProps) {
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);
  const [data, setData] = useState<{ data: ApiKey[]; total: number } | null>(
    null
  );
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    getEndpointKeys(endpointId, { page, pageSize })
      .then((response) => {
        setData(response);
        setLoading(false);
      })
      .catch((error) => {
        console.error("Error fetching data:", error);
        setLoading(false);
      });
  }, [endpointId, page, pageSize]);
  return (
    <DataTable
      columns={columns}
      data={data?.data ?? []}
      pageNumber={page}
      rowCount={data?.total}
      pageSize={pageSize}
      loading={loading}
      onPagination={(page, pageSize) => {
        setPage(page);
        setPageSize(pageSize);
      }}
    />
  );
}

================
File: src/app/admin/api-endpoints/_components/records-list.tsx
================
"use client";

import { DataTable } from "@/components/shared/data-table";
import { ColumnDef } from "@tanstack/react-table";
import { formatDateTime } from "@/lib/utils";
import { getEndpointRecords } from "../actions";
import { useEffect, useState } from "react";
import { ApiEndpointLog } from "@prisma/client";

interface RecordsListProps {
  endpointId: string;
}

const columns: ColumnDef<ApiEndpointLog>[] = [
  {
    accessorKey: "id",
    header: "ID",
  },
  {
    accessorKey: "method",
    header: "è¯·æ±‚æ–¹æ³•",
  },
  {
    accessorKey: "status",
    header: "çŠ¶æ€ç ",
  },
  {
    accessorKey: "ip",
    header: "IPåœ°å€",
  },
  {
    accessorKey: "duration",
    header: "è€—æ—¶(ms)",
  },
  {
    accessorKey: "createdAt",
    header: "è°ƒç”¨æ—¶é—´",
    cell: ({ row }) => formatDateTime(row.original.createdAt),
  },
];

export function RecordsList({ endpointId }: RecordsListProps) {
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);
  const [data, setData] = useState<{
    data: ApiEndpointLog[];
    total: number;
  } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    getEndpointRecords(endpointId, { page, pageSize })
      .then((response) => {
        setData(response);
        setLoading(false);
      })
      .catch((error) => {
        console.error("Error fetching data:", error);
        setLoading(false);
      });
  }, [endpointId, page, pageSize]);

  return (
    <DataTable
      columns={columns}
      data={data?.data ?? []}
      pageNumber={page}
      rowCount={data?.total}
      pageSize={pageSize}
      loading={loading}
      onPagination={(page, pageSize) => {
        setPage(page);
        setPageSize(pageSize);
      }}
    />
  );
}

================
File: src/app/admin/api-endpoints/[id]/detail/page.tsx
================
import { notFound } from "next/navigation";
import { getApiEndpoint } from "../../actions";
import { Button } from "@/components/ui/button";
import { Edit } from "lucide-react";
import Link from "next/link";
import { BasicInfo } from "../../_components/basic-info";
import { DetailTabs } from "../../_components/detail-tabs";

interface ApiEndpointDetailPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function ApiEndpointDetailPage({
  params,
}: ApiEndpointDetailPageProps) {
  const { id } = await params;
  const apiEndpoint = await getApiEndpoint(id);

  if (!apiEndpoint) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">APIç«¯ç‚¹è¯¦æƒ…</h1>
        <Link href={`/admin/api-endpoints/${id}`}>
          <Button>
            <Edit className="mr-2 h-4 w-4" />
            ç¼–è¾‘
          </Button>
        </Link>
      </div>

      <div className="grid grid-cols-5 gap-6">
        {/* å·¦ä¾§è¯¦æƒ…ä¿¡æ¯ */}
        <div className="col-span-2">
          <BasicInfo apiEndpoint={apiEndpoint} />
        </div>

        {/* å³ä¾§æ ‡ç­¾é¡µ */}
        <div className="col-span-3">
          <DetailTabs apiEndpoint={apiEndpoint} />
        </div>
      </div>
    </div>
  );
}

================
File: src/app/admin/api-endpoints/[id]/page.tsx
================
import { notFound } from "next/navigation";
import { ApiEndpointForm } from "../_components/form";
import { getApiEndpoint, getWebhookOptions } from "../actions";

interface EditApiEndpointPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditApiEndpointPage({
  params,
}: EditApiEndpointPageProps) {
  const { id } = await params;
  const [apiEndpoint, webhookOptions] = await Promise.all([
    getApiEndpoint(id),
    getWebhookOptions(),
  ]);

  if (!apiEndpoint) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">ç¼–è¾‘APIç«¯ç‚¹</h1>
      </div>
      <div className="rounded-md border p-4">
        <ApiEndpointForm
          initialData={apiEndpoint}
          webhookOptions={webhookOptions}
        />
      </div>
    </div>
  );
}

================
File: src/app/admin/api-endpoints/actions.ts
================
"use server";

import { db } from "@/lib/db";
import { ApiEndpointsService } from "@/service/api-endpoints.service";
import { revalidatePath } from "next/cache";

// è·å–APIç«¯ç‚¹åˆ—è¡¨
export async function getApiEndpoints(
  query: PageableQuery<typeof db.apiEndpoint> = { page: 1, pageSize: 10 }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.apiEndpoint.count({ where: query.where }),
    db.apiEndpoint.findMany({
      skip,
      take: query.pageSize,
      orderBy: {
        createdAt: "desc",
      },
      where: query.where,
      include: {
        cozeWebhook: true,
        _count: {
          select: {
            apiKeys: true,
            logs: true,
          },
        },
      },
    }),
  ]);

  return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
  };
}

// åˆ›å»ºAPIç«¯ç‚¹
export async function createApiEndpoint(data: {
  cozeWebhookId: string;
  type: string;
  name: string;
  description?: string;
}) {
  const apiEndpoint = await db.apiEndpoint.create({
    data,
  });
  revalidatePath("/admin/api-endpoints");
  return apiEndpoint;
}

// æ›´æ–°APIç«¯ç‚¹
export async function updateApiEndpoint(
  id: string,
  data: {
    type: string;
    name: string;
    description?: string;
  }
) {
  const apiEndpoint = await db.apiEndpoint.update({
    where: { id },
    data,
  });
  revalidatePath("/admin/api-endpoints");
  return apiEndpoint;
}

// åˆ é™¤APIç«¯ç‚¹
export async function deleteApiEndpoint(id: string) {
  await db.apiEndpoint.delete({
    where: { id },
  });
  revalidatePath("/admin/api-endpoints");
}

// è·å–å•ä¸ªAPIç«¯ç‚¹
export async function getApiEndpoint(id: string) {
  return ApiEndpointsService.getApiendpoint(id);
}

// è·å–æ‰€æœ‰Webhooké€‰é¡¹
export async function getWebhookOptions() {
  return db.cozeWebhook.findMany({
    select: {
      id: true,
      url: true,
      name: true,
    },
    orderBy: {
      createdAt: "desc",
    },
  });
}

// è·å–APIç«¯ç‚¹å¯†é’¥åˆ—è¡¨
export async function getEndpointKeys(
  endpointId: string,
  query: PageableQuery<typeof db.apiKey> = { page: 1, pageSize: 10 }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.apiKey.count({
      where: {
        apiEndpoints: {
          some: {
            id: endpointId,
          },
        },
        ...query.where,
      },
    }),
    db.apiKey.findMany({
      skip,
      take: query.pageSize,
      where: {
        apiEndpoints: {
          some: {
            id: endpointId,
          },
        },
        ...query.where,
      },
      orderBy: {
        createdAt: "desc",
      },
    }),
  ]);

  return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
  };
}

// è·å–APIç«¯ç‚¹è°ƒç”¨è®°å½•
export async function getEndpointRecords(
  endpointId: string,
  query: { page: number; pageSize: number }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.apiEndpointLog.count({
      where: { apiEndpointId: endpointId },
    }),
    db.apiEndpointLog.findMany({
      where: { apiEndpointId: endpointId },
      skip,
      take: query.pageSize,
      orderBy: {
        createdAt: "desc",
      },
    }),
  ]);

  return {
    data,
    total,
  };
}

================
File: src/app/admin/api-endpoints/columns.tsx
================
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { ApiEndpoint } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deleteApiEndpoint } from "./actions";
import Link from "next/link";
import { RemoveButton } from "@/components/remove-button";

type ApiEndpointWithWebhook = ApiEndpoint & {
  cozeWebhook: {
    name: string;
    url: string;
  };
};

export const columns: ColumnDef<ApiEndpointWithWebhook>[] = [
  {
    accessorKey: "name",
    header: "åç§°",
    cell: ({ row }) => {
      return (
        <Link
          className="text-blue-600 hover:underline"
          href={`api-endpoints/${row.original.id}/detail`}
        >
          {row.original.name}
        </Link>
      );
    },
  },
  {
    accessorKey: "path",
    header: "è·¯å¾„",
    cell: ({ row }) => {
      if (row.original.type === "openaiLike") {
        return `/api/v1/chat/completion`;
      }
      return `/api/${row.original.id}`;
    },
  },
  {
    accessorKey: "type",
    header: "ç±»å‹",
    cell: ({ row }) => {
      const type = row.original.type;
      return type === "openaiLike" ? "OpenAIå…¼å®¹" : "æ™®é€šè¯·æ±‚";
    },
  },
  {
    accessorKey: "cozeWebhook",
    header: "æ‰€å±Webhook",
    cell: ({ row }) => {
      const webhook = row.original.cozeWebhook;
      return webhook.name;
    },
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const apiEndpoint = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIç«¯ç‚¹å—ï¼Ÿ")) return;
        await deleteApiEndpoint(apiEndpoint.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`api-endpoints/${apiEndpoint.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/api-endpoints/new/page.tsx
================
import { ApiEndpointForm } from "../_components/form";
import { getWebhookOptions } from "../actions";

export default async function NewApiEndpointPage() {
  const webhookOptions = await getWebhookOptions();

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">æ–°å»ºAPIç«¯ç‚¹</h1>
      </div>
      <div className="rounded-md border p-4">
        <ApiEndpointForm webhookOptions={webhookOptions} />
      </div>
    </div>
  );
}

================
File: src/app/admin/api-endpoints/page.tsx
================
import { getApiEndpoints } from "./actions";
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";

export default async function ApiEndpointsPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">APIæœåŠ¡ç®¡ç†</h1>
        <Link href="/admin/api-endpoints/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºAPIç«¯ç‚¹
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/admin/api-endpoints"
        load={(data) =>
          getApiEndpoints({
            page: data.page,
            pageSize: data.pageSize,
            where: data.keyword
              ? {
                  OR: [
                    { name: { contains: data.keyword } },
                    { description: { contains: data.keyword } },
                    { type: { contains: data.keyword } },
                  ],
                }
              : {},
          })
        }
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/api-keys/_components/form.tsx
================
"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { useRouter } from "next/navigation";
import { ApiKey, ApiEndpoint } from "@prisma/client";
import { createApiKey, updateApiKey } from "../actions";
import { useToast } from "@/hooks/use-toast";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Checkbox } from "@/components/ui/checkbox";

const apiKeyFormSchema = z.object({
  apiEndpointIds: z.array(z.string()).min(1, "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªAPIç«¯ç‚¹"),
});

type ApiKeyFormValues = z.infer<typeof apiKeyFormSchema>;

interface ApiEndpointOption {
  id: string;
  name: string;
  type: string;
  cozeWebhook: {
    url: string;
    name: string;
  };
}

interface ApiKeyFormProps {
  initialData?: ApiKey & {
    apiEndpoints: ApiEndpoint[];
  };
  apiEndpointOptions: ApiEndpointOption[];
}

export function ApiKeyForm({
  initialData,
  apiEndpointOptions,
}: ApiKeyFormProps) {
  const router = useRouter();
  const { toast } = useToast();

  const form = useForm<ApiKeyFormValues>({
    resolver: zodResolver(apiKeyFormSchema),
    defaultValues: {
      apiEndpointIds:
        initialData?.apiEndpoints.map((endpoint) => endpoint.id) || [],
    },
  });

  async function onSubmit(data: ApiKeyFormValues) {
    try {
      if (initialData) {
        await updateApiKey(initialData.id, data);
      } else {
        await createApiKey(data);
      }
      router.push("/admin/api-keys");
      router.refresh();
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="apiEndpointIds"
          render={() => (
            <FormItem>
              <FormLabel>é€‰æ‹©APIç«¯ç‚¹</FormLabel>
              <ScrollArea className="h-72 rounded-md border">
                <div className="space-y-4 p-4">
                  {apiEndpointOptions.map((endpoint) => (
                    <FormField
                      key={endpoint.id}
                      control={form.control}
                      name="apiEndpointIds"
                      render={({ field }) => {
                        return (
                          <FormItem
                            key={endpoint.id}
                            className="flex flex-row items-start space-x-3 space-y-0"
                          >
                            <FormControl>
                              <Checkbox
                                checked={field.value?.includes(endpoint.id)}
                                onCheckedChange={(checked) => {
                                  return checked
                                    ? field.onChange([
                                        ...field.value,
                                        endpoint.id,
                                      ])
                                    : field.onChange(
                                        field.value?.filter(
                                          (value) => value !== endpoint.id
                                        )
                                      );
                                }}
                              />
                            </FormControl>
                            <div className="space-y-1 leading-none">
                              <FormLabel className="text-sm font-normal">
                                {endpoint.name}
                                <span className="ml-2 text-gray-500">
                                  (
                                  {endpoint.type === "openaiLike"
                                    ? "OpenAIå…¼å®¹"
                                    : "æ™®é€šè¯·æ±‚"}
                                  )
                                </span>
                              </FormLabel>
                              <p className="text-xs text-gray-500">
                                Webhook: {endpoint.cozeWebhook.name}
                              </p>
                            </div>
                          </FormItem>
                        );
                      }}
                    />
                  ))}
                </div>
              </ScrollArea>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/api-keys/[id]/page.tsx
================
import { notFound } from "next/navigation";
import { ApiKeyForm } from "../_components/form";
import { getApiKey, getApiEndpointOptions } from "../actions";

interface EditApiKeyPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditApiKeyPage({ params }: EditApiKeyPageProps) {
  const { id } = await params;
  const [apiKey, apiEndpointOptions] = await Promise.all([
    getApiKey(id),
    getApiEndpointOptions(),
  ]);

  if (!apiKey) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">ç¼–è¾‘APIå¯†é’¥</h1>
      </div>
      <div className="rounded-md border p-4">
        <ApiKeyForm
          initialData={apiKey}
          apiEndpointOptions={apiEndpointOptions}
        />
      </div>
    </div>
  );
}

================
File: src/app/admin/api-keys/actions.ts
================
"use server";

import { db } from "@/lib/db";
import { revalidatePath } from "next/cache";
import { randomUUID } from "crypto";

// è·å–APIå¯†é’¥åˆ—è¡¨
export async function getApiKeys(
  query: PageableQuery<typeof db.apiKey> = { page: 1, pageSize: 10 }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.apiKey.count({ where: query.where }),
    db.apiKey.findMany({
      skip,
      take: query.pageSize,
      orderBy: {
        createdAt: "desc",
      },
      where: query.where,
      include: {
        apiEndpoints: {
          include: {
            cozeWebhook: true,
          },
        },
      },
    }),
  ]);

  return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
  };
}

// åˆ›å»ºAPIå¯†é’¥
export async function createApiKey(data: { apiEndpointIds: string[] }) {
  const apiKey = await db.apiKey.create({
    data: {
      key: `ak-${randomUUID()}`,
      apiEndpoints: {
        connect: data.apiEndpointIds.map((id) => ({ id })),
      },
    },
    include: {
      apiEndpoints: true,
    },
  });
  revalidatePath("/admin/api-keys");
  return apiKey;
}

// æ›´æ–°APIå¯†é’¥
export async function updateApiKey(
  id: string,
  data: {
    apiEndpointIds: string[];
  }
) {
  const apiKey = await db.apiKey.update({
    where: { id },
    data: {
      apiEndpoints: {
        set: data.apiEndpointIds.map((id) => ({ id })),
      },
    },
    include: {
      apiEndpoints: true,
    },
  });
  revalidatePath("/admin/api-keys");
  return apiKey;
}

// åˆ é™¤APIå¯†é’¥
export async function deleteApiKey(id: string) {
  await db.apiKey.delete({
    where: { id },
  });
  revalidatePath("/admin/api-keys");
}

// è·å–å•ä¸ªAPIå¯†é’¥
export async function getApiKey(id: string) {
  return db.apiKey.findUnique({
    where: { id },
    include: {
      apiEndpoints: {
        include: {
          cozeWebhook: true,
        },
      },
    },
  });
}

// è·å–å®Œæ•´çš„APIå¯†é’¥
export async function getFullApiKey(id: string) {
  const apiKey = await db.apiKey.findUnique({
    where: { id },
    select: {
      key: true,
    },
  });

  if (!apiKey) {
    throw new Error("APIå¯†é’¥ä¸å­˜åœ¨");
  }

  return apiKey;
}

// è·å–APIç«¯ç‚¹é€‰é¡¹
export async function getApiEndpointOptions() {
  return db.apiEndpoint.findMany({
    select: {
      id: true,
      name: true,
      type: true,
      cozeWebhook: {
        select: {
          id: true,
          name: true,
          url: true,
        },
      },
    },
    orderBy: {
      createdAt: "desc",
    },
  });
}

================
File: src/app/admin/api-keys/columns.tsx
================
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { ApiKey, ApiEndpoint, CozeWebhook } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit, Copy } from "lucide-react";
import { deleteApiKey } from "./actions";
import Link from "next/link";
import { RemoveButton } from "@/components/remove-button";
import { useToast } from "@/hooks/use-toast";
import { getApiKey } from "./actions";

type ApiKeyWithRelations = ApiKey & {
  apiEndpoints: (ApiEndpoint & {
    cozeWebhook: CozeWebhook;
  })[];
};

const CopyButton = ({ id }: { id: string }) => {
  const { toast } = useToast();
  const copyKey = async () => {
    try {
      const fullKey = await getApiKey(id);
      if (fullKey == null) {
        throw new Error("APIå¯†é’¥ä¸å­˜åœ¨");
      }
      await navigator.clipboard.writeText(fullKey?.key);
      toast({
        title: "å¤åˆ¶æˆåŠŸ",
        description: "APIå¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
      });
    } catch (error) {
      toast({
        title: "å¤åˆ¶å¤±è´¥",
        description: error instanceof Error ? error.message : "æœªçŸ¥é”™è¯¯",
        variant: "destructive",
      });
    }
  };

  return (
    <Button variant="ghost" size="icon" className="h-8 w-8" onClick={copyKey}>
      <Copy className="h-4 w-4" />
    </Button>
  );
};

export const columns: ColumnDef<ApiKeyWithRelations>[] = [
  {
    accessorKey: "key",
    header: "APIå¯†é’¥",
    cell: ({ row }) => {
      return (
        <div className="flex items-center gap-2">
          <code className="rounded bg-muted px-[0.3rem] py-[0.2rem] font-mono text-sm font-semibold">
            ak-{"*".repeat(30)}
          </code>
          <CopyButton id={row.original.id} />
        </div>
      );
    },
  },
  {
    accessorKey: "apiEndpoints",
    header: "å…³è”çš„APIç«¯ç‚¹",
    cell: ({ row }) => {
      const apiEndpoints = row.original.apiEndpoints;
      return (
        <div className="space-y-1">
          {apiEndpoints.map((endpoint) => (
            <div key={endpoint.id} className="text-sm">
              <Link
                href={`api-endpoints/${endpoint.id}`}
                className="text-blue-600 hover:underline"
              >
                {endpoint.name}
              </Link>
              <span className="text-gray-500">
                {" "}
                ({endpoint.type === "openaiLike" ? "OpenAIå…¼å®¹" : "æ™®é€šè¯·æ±‚"})
              </span>
              <div className="text-xs text-gray-500">
                Webhook: {endpoint.cozeWebhook.name}
              </div>
            </div>
          ))}
        </div>
      );
    },
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const apiKey = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿ")) return;
        await deleteApiKey(apiKey.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/admin/api-keys/${apiKey.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/api-keys/new/page.tsx
================
import { ApiKeyForm } from "../_components/form";
import { getApiEndpointOptions } from "../actions";

export default async function NewApiKeyPage() {
  const apiEndpointOptions = await getApiEndpointOptions();

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">æ–°å»ºAPIå¯†é’¥</h1>
      </div>
      <div className="rounded-md border p-4">
        <ApiKeyForm apiEndpointOptions={apiEndpointOptions} />
      </div>
    </div>
  );
}

================
File: src/app/admin/api-keys/page.tsx
================
import { getApiKeys } from "./actions";
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";

export default async function ApiKeysPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">APIå¯†é’¥ç®¡ç†</h1>
        <Link href="/admin/api-keys/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºAPIå¯†é’¥
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/admin/api-keys"
        load={(data) =>
          getApiKeys({
            page: data.page,
            pageSize: data.pageSize,
            where: data.keyword
              ? {
                  key: { contains: data.keyword },
                }
              : {},
          })
        }
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/api-logs/[id]/page.tsx
================
import { notFound } from "next/navigation";
import { getApiLog } from "../actions";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

interface ApiLogDetailPageProps {
  params: {
    id: string;
  };
}

export default async function ApiLogDetailPage({
  params,
}: ApiLogDetailPageProps) {
  const log = await getApiLog(params.id);

  if (!log) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">APIè°ƒç”¨æ—¥å¿—è¯¦æƒ…</h1>
      </div>
      <div className="grid gap-6">
        <Card>
          <CardHeader>
            <CardTitle>åŸºæœ¬ä¿¡æ¯</CardTitle>
          </CardHeader>
          <CardContent>
            <dl className="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <div>
                <dt className="text-sm font-medium text-gray-500">APIç«¯ç‚¹</dt>
                <dd className="mt-1">
                  <Link
                    href={`/api-endpoints/${log.apiEndpoint.id}`}
                    className="text-blue-600 hover:underline"
                  >
                    {log.apiEndpoint.name}
                  </Link>
                  <Badge variant="outline" className="ml-2">
                    {log.apiEndpoint.type === "openaiLike"
                      ? "OpenAIå…¼å®¹"
                      : "æ™®é€šè¯·æ±‚"}
                  </Badge>
                </dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">
                  CozeWebhook
                </dt>
                <dd className="mt-1">
                  <Link
                    href={`/webhooks/${log.cozeWebhook.id}`}
                    className="text-blue-600 hover:underline"
                  >
                    {log.cozeWebhook.name}
                  </Link>
                </dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">APIå¯†é’¥</dt>
                <dd className="mt-1">
                  <code className="rounded bg-muted px-2 py-1">
                    {log.apiKey}
                  </code>
                </dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">è°ƒç”¨æ—¶é—´</dt>
                <dd className="mt-1">
                  {new Date(log.createdAt).toLocaleString()}
                </dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">è€—æ—¶</dt>
                <dd className="mt-1">
                  <span
                    className={
                      log.duration > 1000 ? "text-yellow-600" : "text-green-600"
                    }
                  >
                    {log.duration}ms
                  </span>
                </dd>
              </div>
            </dl>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>è¯·æ±‚å‚æ•°</CardTitle>
          </CardHeader>
          <CardContent>
            <pre className="whitespace-pre-wrap rounded-lg bg-muted p-4">
              {JSON.stringify(JSON.parse(log.requestParams), null, 2)}
            </pre>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>å“åº”å†…å®¹</CardTitle>
          </CardHeader>
          <CardContent>
            <pre className="whitespace-pre-wrap rounded-lg bg-muted p-4">
              {JSON.stringify(JSON.parse(log.response), null, 2)}
            </pre>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

================
File: src/app/admin/api-logs/actions.ts
================
"use server";

import { db } from "@/lib/db";

// è·å–APIæ—¥å¿—åˆ—è¡¨
export async function getApiLogs(
  query: PageableQuery<typeof db.apiEndpointLog> = { page: 1, pageSize: 10 }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.apiEndpointLog.count({ where: query.where }),
    db.apiEndpointLog.findMany({
      skip,
      take: query.pageSize,
      orderBy: {
        createdAt: "desc",
      },
      where: query.where,
      include: {
        apiEndpoint: true,
        cozeWebhook: true,
      },
    }),
  ]);

  return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
  };
}

// è·å–å•ä¸ªAPIæ—¥å¿—è¯¦æƒ…
export async function getApiLog(id: string) {
  return db.apiEndpointLog.findUnique({
    where: { id },
    include: {
      apiEndpoint: true,
      cozeWebhook: true,
    },
  });
}

================
File: src/app/admin/api-logs/columns.tsx
================
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { ApiEndpointLog, ApiEndpoint, CozeWebhook } from "@prisma/client";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { Eye } from "lucide-react";
import { Badge } from "@/components/ui/badge";

type ApiLogWithRelations = ApiEndpointLog & {
  apiEndpoint: ApiEndpoint;
  cozeWebhook: CozeWebhook;
};

export const columns: ColumnDef<ApiLogWithRelations>[] = [
  {
    accessorKey: "apiEndpoint.name",
    header: "APIç«¯ç‚¹",
    cell: ({ row }) => {
      const apiEndpoint = row.original.apiEndpoint;
      return (
        <div>
          <Link
            href={`/api-endpoints/${apiEndpoint.id}`}
            className="text-blue-600 hover:underline"
          >
            {apiEndpoint.name}
          </Link>
          <Badge variant="outline" className="ml-2">
            {apiEndpoint.type === "openaiLike" ? "OpenAIå…¼å®¹" : "æ™®é€šè¯·æ±‚"}
          </Badge>
        </div>
      );
    },
  },
  {
    accessorKey: "cozeWebhook.url",
    header: "Webhook",
    cell: ({ row }) => {
      const webhook = row.original.cozeWebhook;
      return (
        <Link
          href={`/webhooks/${webhook.id}`}
          className="text-blue-600 hover:underline"
        >
          {webhook.name}
        </Link>
      );
    },
  },
  {
    accessorKey: "apiKey",
    header: "APIå¯†é’¥",
    cell: ({ row }) => {
      return (
        <code className="rounded bg-muted px-2 py-1 text-sm">
          {row.original.apiKey}
        </code>
      );
    },
  },
  {
    accessorKey: "duration",
    header: "è€—æ—¶",
    cell: ({ row }) => {
      const duration = row.original.duration;
      if (duration == null) {
        return <span className="text-muted-foreground">--ms</span>;
      }
      return (
        <span
          className={duration > 1000 ? "text-yellow-600" : "text-green-600"}
        >
          {duration}ms
        </span>
      );
    },
  },
  {
    accessorKey: "createdAt",
    header: "è°ƒç”¨æ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const log = row.original;
      return (
        <Link href={`api-logs/${log.id}`}>
          <Button className="h-8 py-0" variant={"ghost"}>
            æŸ¥çœ‹è¯¦æƒ…
            <Eye className="ml-2 h-4 w-4" />
          </Button>
        </Link>
      );
    },
  },
];

================
File: src/app/admin/api-logs/page.tsx
================
import { getApiLogs } from "./actions";
import { columns } from "./columns";
import PageTable from "@/components/page-table";

export default async function ApiLogsPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">APIè°ƒç”¨æ—¥å¿—</h1>
      </div>
      <PageTable
        basePath="/api-logs"
        load={(data) =>
          getApiLogs({
            page: data.page,
            pageSize: data.pageSize,
            where: data.keyword
              ? {
                  OR: [
                    { apiKey: { contains: data.keyword } },
                    { requestParams: { contains: data.keyword } },
                    { response: { contains: data.keyword } },
                  ],
                }
              : {},
          })
        }
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/dashboard/_components/new-users.tsx
================
"use client";

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { User } from "@prisma/client";
import { formatDistanceToNow } from "date-fns";
import { zhCN } from "date-fns/locale";

interface NewUsersProps {
  users: User[];
}

export function NewUsers({ users }: NewUsersProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>ä»Šæ—¥æ–°å¢ç”¨æˆ·</CardTitle>
        <CardDescription>ä»Šå¤©æ–°æ³¨å†Œçš„ç”¨æˆ·åˆ—è¡¨</CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {users.length === 0 ? (
          <p className="py-4 text-center text-sm text-muted-foreground">
            ä»Šå¤©è¿˜æ²¡æœ‰æ–°ç”¨æˆ·æ³¨å†Œ
          </p>
        ) : (
          users.map((user) => (
            <div
              key={user.id}
              className="flex items-center gap-4 rounded-lg border p-4"
            >
              <Avatar>
                <AvatarImage src={user.avatar ?? ""} />
                <AvatarFallback className="bg-primary/10">
                  {user.name?.[0] ?? "U"}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1 space-y-1">
                <p className="text-sm font-medium leading-none">{user.name}</p>
                <p className="text-sm text-muted-foreground">{user.email}</p>
              </div>
              <p className="text-sm text-muted-foreground">
                {formatDistanceToNow(user.createdAt, {
                  addSuffix: true,
                  locale: zhCN,
                })}
              </p>
            </div>
          ))
        )}
      </CardContent>
    </Card>
  );
}

================
File: src/app/admin/dashboard/_components/welcome.tsx
================
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { auth } from "@/lib/auth";
import { getGreeting } from "@/lib/utils";

export async function Welcome() {
  const session = await auth();
  const greeting = getGreeting();

  if (!session?.user) return null;

  return (
    <div className="mb-8 flex items-center gap-4">
      <Avatar className="h-16 w-16">
        <AvatarImage src={session.user.image ?? ""} />
        <AvatarFallback className="bg-primary/10">
          {session.user.name?.[0] ?? "U"}
        </AvatarFallback>
      </Avatar>
      <div>
        <h2 className="text-2xl font-bold tracking-tight">
          {greeting}ï¼Œ{session.user.name}
        </h2>
        <p className="text-muted-foreground">æ¬¢è¿å›åˆ°å·¥ä½œå°ï¼Œç¥æ‚¨å·¥ä½œæ„‰å¿«ï¼</p>
      </div>
    </div>
  );
}

================
File: src/app/admin/dashboard/page.tsx
================
import { db } from "@/lib/db";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Webhook, WebhookOff, Loader2 } from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { zhCN } from "date-fns/locale";

async function getStats() {
  const [
    totalWebhooks,
    totalApiEndpoints,
    totalApiKeys,
    totalLogs,
    recentLogs,
    endpointStats,
  ] = await Promise.all([
    db.cozeWebhook.count(),
    db.apiEndpoint.count(),
    db.apiKey.count(),
    db.apiEndpointLog.count(),
    db.apiEndpointLog.findMany({
      take: 5,
      orderBy: {
        createdAt: "desc",
      },
      include: {
        apiEndpoint: true,
      },
    }),
    db.apiEndpoint.findMany({
      select: {
        id: true,
        name: true,
        _count: {
          select: {
            logs: true,
          },
        },
      },
      orderBy: {
        logs: {
          _count: "desc",
        },
      },
      take: 5,
    }),
  ]);

  // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
  const avgDuration = await db.apiEndpointLog.aggregate({
    _avg: {
      duration: true,
    },
  });

  return {
    totalWebhooks,
    totalApiEndpoints,
    totalApiKeys,
    totalLogs,
    recentLogs,
    endpointStats,
    avgDuration: Math.round(avgDuration._avg.duration || 0),
  };
}

export default async function DashboardPage() {
  const stats = await getStats();

  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-8 text-2xl font-bold">ä»ªè¡¨ç›˜</h1>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Webhookæ€»æ•°</CardTitle>
            <Webhook className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.totalWebhooks}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">APIç«¯ç‚¹æ€»æ•°</CardTitle>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              className="h-4 w-4 text-muted-foreground"
            >
              <path d="M4 21v-7a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v7" />
              <path d="M7 21h10" />
              <path d="M12 17v-6" />
              <path d="M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" />
            </svg>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.totalApiEndpoints}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">APIå¯†é’¥æ€»æ•°</CardTitle>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              className="h-4 w-4 text-muted-foreground"
            >
              <path d="M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3" />
            </svg>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.totalApiKeys}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">å¹³å‡å“åº”æ—¶é—´</CardTitle>
            <Loader2 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.avgDuration}ms</div>
          </CardContent>
        </Card>
      </div>

      <div className="mt-4 grid gap-4 md:grid-cols-2 lg:grid-cols-7">
        <Card className="col-span-4">
          <CardHeader>
            <CardTitle>æœ€è¿‘è°ƒç”¨è®°å½•</CardTitle>
            <CardDescription>æ˜¾ç¤ºæœ€è¿‘5æ¡APIè°ƒç”¨è®°å½•</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-8">
              {stats.recentLogs.map((log) => (
                <div key={log.id} className="flex items-center">
                  <div className="ml-4 space-y-1">
                    <p className="text-sm font-medium leading-none">
                      {log.apiEndpoint.name}
                    </p>
                    <p className="text-sm text-muted-foreground">
                      è°ƒç”¨æ—¶é—´ï¼š
                      {formatDistanceToNow(new Date(log.createdAt), {
                        addSuffix: true,
                        locale: zhCN,
                      })}
                      {" Â· "}
                      è€—æ—¶ï¼š{log.duration}ms
                    </p>
                  </div>
                  {log.duration > 1000 && (
                    <WebhookOff className="ml-auto h-4 w-4 text-yellow-500" />
                  )}
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
        <Card className="col-span-3">
          <CardHeader>
            <CardTitle>è°ƒç”¨é‡TOP5çš„APIç«¯ç‚¹</CardTitle>
            <CardDescription>æŒ‰è°ƒç”¨æ¬¡æ•°æ’åºçš„å‰5ä¸ªAPIç«¯ç‚¹</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-8">
              {stats.endpointStats.map((endpoint) => (
                <div key={endpoint.id} className="flex items-center">
                  <div className="ml-4 space-y-1">
                    <p className="text-sm font-medium leading-none">
                      {endpoint.name}
                    </p>
                    <p className="text-sm text-muted-foreground">
                      è°ƒç”¨æ¬¡æ•°ï¼š{endpoint._count.logs}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

================
File: src/app/admin/layout.tsx
================
import type { Metadata } from "next";
import { SidebarProvider, SidebarTrigger } from "@/components/ui/sidebar";
import { AppSidebar } from "@/components/app-sidebar";

export const metadata: Metadata = {
  title: "æ‰£å­æœåŠ¡ç®¡ç†ç³»ç»Ÿ",
  description: "ä¸€é”®ç®¡ç†æ‰£å­webhookæœåŠ¡-åå°ç®¡ç†ç³»ç»Ÿ",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <SidebarProvider>
      <AppSidebar />
      <main className="w-full p-5">
        <div className="mb-2">
          <SidebarTrigger />
        </div>
        <div className="bg-background/15">{children}</div>
      </main>
    </SidebarProvider>
  );
}

================
File: src/app/admin/loading.tsx
================
import { Skeleton } from "@/components/ui/skeleton";

export default function Loading() {
  return (
    <div className="container mx-auto p-8 animate-in fade-in-50">
      {/* é¡µé¢æ ‡é¢˜éª¨æ¶ */}
      <div className="mb-8 flex items-center justify-between">
        <Skeleton className="h-8 w-48" />
        <Skeleton className="h-10 w-32" />
      </div>

      {/* å¡ç‰‡åˆ—è¡¨éª¨æ¶ */}
      <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {Array.from({ length: 6 }).map((_, i) => (
          <div
            key={i}
            className="group relative overflow-hidden rounded-lg border bg-background p-2"
          >
            {/* å¡ç‰‡å›¾ç‰‡éª¨æ¶ */}
            <Skeleton className="aspect-video w-full rounded-md" />

            {/* å¡ç‰‡å†…å®¹éª¨æ¶ */}
            <div className="space-y-4 p-4">
              <div className="space-y-2">
                <Skeleton className="h-5 w-3/4" />
                <Skeleton className="h-4 w-1/2" />
              </div>

              {/* æ ‡ç­¾éª¨æ¶ */}
              <div className="flex flex-wrap gap-2">
                <Skeleton className="h-6 w-16 rounded-full" />

                <Skeleton className="h-6 w-20 rounded-full" />

                <Skeleton className="h-6 w-14 rounded-full" />
              </div>

              {/* æè¿°éª¨æ¶ */}
              <div className="space-y-2">
                <Skeleton className="h-4 w-full" />
                <Skeleton className="h-4 w-5/6" />
                <Skeleton className="h-4 w-4/6" />
              </div>

              {/* åº•éƒ¨ä¿¡æ¯éª¨æ¶ */}
              <div className="flex items-center justify-between pt-2">
                <Skeleton className="h-5 w-24" />
                <Skeleton className="h-8 w-8 rounded-full" />
              </div>
            </div>

            {/* Sketch é£æ ¼è£…é¥° */}
            <div className="pointer-events-none absolute inset-0">
              <div className="absolute inset-0 bg-gradient-to-t from-background/10 to-background/5 opacity-0 transition-opacity group-hover:opacity-100" />

              <div className="absolute -inset-px rounded-lg border border-foreground/10" />

              <div className="absolute -inset-[2px] rounded-lg border border-foreground/5 opacity-0 transition-opacity group-hover:opacity-100" />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

================
File: src/app/admin/menus/_components/menu-form.tsx
================
"use client";
import React, { useState, useEffect } from "react";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";
import { Menu } from "@prisma/client";
import { createMenu, updateMenu, fetchMenus } from "../actions";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from "@/components/ui/select";
import { useToast } from "@/hooks/use-toast";

const menuFormSchema = z.object({
  name: z.string().min(1, "èœå•åç§°ä¸èƒ½ä¸ºç©º"),
  url: z.string().min(1, "URLä¸èƒ½ä¸ºç©º"),
  orderNum: z.number().min(0, "æ’åºå·å¿…é¡»å¤§äºç­‰äº0"),
  parentId: z.string().nullable(),
  icon: z.string().optional().nullable(),
});

type MenuFormValues = z.infer<typeof menuFormSchema>;

interface MenuFormProps {
  initialData?: Menu;
}

export function MenuForm({ initialData }: MenuFormProps) {
  const router = useRouter();
  const [menus, setMenus] = useState<Menu[]>([]);
  const { toast } = useToast();

  useEffect(() => {
    const loadMenus = async () => {
      const data = await fetchMenus();
      setMenus(data);
    };
    loadMenus();
  }, []);

  const form = useForm<MenuFormValues>({
    resolver: zodResolver(menuFormSchema),
    defaultValues: initialData || {
      name: "",
      url: "",
      orderNum: 0,
      parentId: null,
      icon: "",
    },
  });

  async function onSubmit(data: MenuFormValues) {
    try {
      if (initialData) {
        await updateMenu(initialData.id, data);
      } else {
        await createMenu(data);
      }
      router.push("/menus");
      router.refresh();
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>èœå•åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥èœå•åç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="url"
          render={({ field }) => (
            <FormItem>
              <FormLabel>URL</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥URL" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="orderNum"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æ’åºå·</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  placeholder="è¯·è¾“å…¥æ’åºå·"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value))}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="parentId"
          render={({ field }) => (
            <FormItem>
              <FormLabel>çˆ¶èœå•</FormLabel>
              <FormControl>
                <Select
                  onValueChange={field.onChange}
                  defaultValue={field.value!}
                  value={field.value!}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="é€‰æ‹©çˆ¶èœå•" />
                  </SelectTrigger>
                  <SelectContent>
                    {menus.map((menu) => (
                      <SelectItem key={menu.id} value={menu.id}>
                        {menu.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="icon"
          render={({ field }) => (
            <FormItem>
              <FormLabel>å›¾æ ‡</FormLabel>
              <FormControl>
                <Input
                  placeholder="è¯·è¾“å…¥å›¾æ ‡"
                  {...field}
                  value={field.value!}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/menus/_components/remove-button.tsx
================
import {
  AlertDialogHeader,
  AlertDialogFooter,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogCancel,
  AlertDialogAction,
} from "@/components/ui/alert-dialog";
import { Trash2 } from "lucide-react";

export function RemoveButton(props: { onDeleteAction: () => void }) {
  const { onDeleteAction } = props;
  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button className="w-full justify-start  text-red-400" variant="ghost">
          <Trash2 className="mr-2 h-4 w-4" />
          åˆ é™¤
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>
          <AlertDialogDescription>
            æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
          <AlertDialogAction onClick={onDeleteAction}>åˆ é™¤</AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}

================
File: src/app/admin/menus/[id]/page.tsx
================
import { Metadata } from "next";
import { MenuForm } from "../_components/menu-form";
import { notFound } from "next/navigation";
import { MenuService } from "@/service/menu.service";

export const metadata: Metadata = {
  title: "ç¼–è¾‘èœå•",
  description: "ç¼–è¾‘ç³»ç»Ÿèœå•",
};

export default async function EditMenuPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const menu = await MenuService.getMenuById(id);

  if (!menu) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">ç¼–è¾‘èœå•</h1>
      <MenuForm initialData={menu} />
    </div>
  );
}

================
File: src/app/admin/menus/actions.ts
================
"use server";
import { MenuService } from "@/service/menu.service";
import { revalidatePath } from "next/cache";

export async function getMenus(
  ...args: Parameters<typeof MenuService.getMenus>
) {
  return MenuService.getMenus(...args);
}

export async function createMenu(data: {
  name: string;
  url: string;
  orderNum: number;
  parentId?: string | null;
  icon?: string | null;
  permissionIds?: string[];
}) {
  await MenuService.createMenu(
    data.name,
    data.url,
    data.orderNum,
    data.parentId,
    data.icon,
    data.permissionIds
  );
  revalidatePath("/menus");
  return { success: true };
}

export async function updateMenu(
  menuId: string,
  data: {
    name?: string;
    url?: string;
    orderNum?: number;
    parentId?: string | null;
    icon?: string | null;
    permissionIds?: string[];
  }
) {
  await MenuService.updateMenu(menuId, data);
  revalidatePath("/menus");
  return { success: true };
}

export async function deleteMenu(menuId: string) {
  await MenuService.deleteMenu(menuId);
  revalidatePath("/menus");
  return { success: true };
}

export async function fetchMenus() {
  return MenuService.list();
}

================
File: src/app/admin/menus/columns.tsx
================
"use client";
import { ColumnDef } from "@tanstack/react-table";
import { Menu } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deleteMenu } from "./actions";
import Link from "next/link";
import { RemoveButton } from "./_components/remove-button";

export const columns: ColumnDef<Menu>[] = [
  {
    accessorKey: "name",
    header: "èœå•åç§°",
  },
  {
    accessorKey: "url",
    header: "URL",
  },
  {
    accessorKey: "orderNum",
    header: "æ’åº",
  },
  {
    accessorKey: "icon",
    header: "å›¾æ ‡",
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const menu = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå•å—ï¼Ÿ")) return;
        await deleteMenu(menu.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/menus/${menu.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/menus/new/page.tsx
================
import { Metadata } from "next";
import { MenuForm } from "../_components/menu-form";

export const metadata: Metadata = {
  title: "æ–°å»ºèœå•",
  description: "åˆ›å»ºæ–°çš„ç³»ç»Ÿèœå•",
};

export default function NewMenuPage() {
  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">æ–°å»ºèœå•</h1>
      <MenuForm />
    </div>
  );
}

================
File: src/app/admin/menus/page.tsx
================
import { getMenus } from "./actions";
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";
import { Metadata } from "next";

export const metadata: Metadata = {
  title: "èœå•",
  description: "èœå•ç®¡ç†",
};

export default async function MenuPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">èœå•ç®¡ç†</h1>
        <Link href="/menus/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºèœå•
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/menus"
        load={getMenus}
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/permissions/_components/permission-form.tsx
================
"use client";

import React from "react";
import { useForm } from "react-hook-form";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useRouter } from "next/navigation";
import { Permission } from "@prisma/client";
import { createPermission, updatePermission } from "../actions";
import { useToast } from "@/hooks/use-toast";
import { PermissionFormValues, permissionResolver } from "./schema";
import { PermissionSelect } from "./permission-select";

interface PermissionFormProps {
  initialData?: Permission;
}

export function PermissionForm({ initialData }: PermissionFormProps) {
  const router = useRouter();
  const { toast } = useToast();

  const form = useForm<PermissionFormValues>({
    resolver: permissionResolver,
    mode: "onBlur",
    defaultValues: initialData || {
      name: "",
      key: "",
      description: "",
      parentId: null,
    },
  });

  async function onSubmit(data: PermissionFormValues) {
    try {
      if (initialData) {
        await updatePermission(initialData.id, data);
      } else {
        await createPermission(data);
      }
      router.push("/permissions");
      router.refresh();
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æƒé™åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥æƒé™åç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="key"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æƒé™é”®</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥æƒé™é”®" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æè¿°</FormLabel>
              <FormControl>
                <Textarea
                  placeholder="è¯·è¾“å…¥æƒé™æè¿°"
                  {...field}
                  value={field.value || ""}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="parentId"
          render={({ field }) => (
            <FormItem>
              <FormLabel>çˆ¶æƒé™</FormLabel>
              <FormControl>
                <PermissionSelect
                  onChange={field.onChange}
                  defaultValue={field.value!}
                  value={field.value!}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/permissions/_components/permission-select.tsx
================
"use client";

import { Permission } from "@prisma/client";
import { useEffect, useState } from "react";
import { fetchPermissions } from "../actions";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

interface PermissionSelectProps {
  value: string | null;
  defaultValue?: string | null;
  onChange: (value: string | null) => void;
}

export function PermissionSelect({
  value,
  defaultValue,
  onChange,
}: PermissionSelectProps) {
  const [permissions, setPermissions] = useState<Permission[]>([]);

  useEffect(() => {
    const loadPermissions = async () => {
      const data = await fetchPermissions();
      setPermissions(data);
    };
    loadPermissions();
  }, []);

  return (
    <Select
      onValueChange={onChange}
      defaultValue={defaultValue ?? undefined}
      value={value ?? undefined}
    >
      <SelectTrigger className="w-full">
        <SelectValue placeholder="é€‰æ‹©çˆ¶æƒé™" />
      </SelectTrigger>
      <SelectContent>
        {permissions.map((perm) => (
          <SelectItem key={perm.id} value={perm.id}>
            {perm.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}

================
File: src/app/admin/permissions/_components/remove-button.tsx
================
import {
  AlertDialogHeader,
  AlertDialogFooter,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogCancel,
  AlertDialogAction,
} from "@/components/ui/alert-dialog";
import { Trash2 } from "lucide-react";

export function RemoveButton(props: { onDeleteAction: () => void }) {
  const { onDeleteAction } = props;
  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button className="w-full justify-start  text-red-400" variant="ghost">
          <Trash2 className="mr-2 h-4 w-4" />
          åˆ é™¤
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>
          <AlertDialogDescription>
            æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
          <AlertDialogAction onClick={onDeleteAction}>åˆ é™¤</AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}

================
File: src/app/admin/permissions/_components/schema.ts
================
import { zodResolver } from "@hookform/resolvers/zod";

import * as z from "zod";

export const permissionFormSchema = z.object({
  name: z.string().min(1, "æƒé™åç§°ä¸èƒ½ä¸ºç©º"),
  key: z.string().min(1, "æƒé™é”®ä¸èƒ½ä¸ºç©º"),
  description: z.string().optional().nullable(),
  parentId: z.string().nullable(), // æ–°å¢çš„å­—æ®µ
});

export type PermissionFormValues = z.infer<typeof permissionFormSchema>;

export const permissionResolver = zodResolver(permissionFormSchema);

================
File: src/app/admin/permissions/[id]/page.tsx
================
import { Metadata } from "next";
import { PermissionForm } from "../_components/permission-form";
import { notFound } from "next/navigation";
import { PermissionService } from "@/service/permission.service";

export const metadata: Metadata = {
  title: "ç¼–è¾‘æƒé™",
  description: "ç¼–è¾‘ç³»ç»Ÿæƒé™",
};

export default async function EditPermissionPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const permission = await PermissionService.getPermissionById(id);

  if (!permission) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">ç¼–è¾‘æƒé™</h1>
      <PermissionForm initialData={permission} />
    </div>
  );
}

================
File: src/app/admin/permissions/actions.ts
================
"use server";

import { PermissionService } from "@/service/permission.service";
import { revalidatePath } from "next/cache";

export async function getPermissions(
  ...args: Parameters<typeof PermissionService.getPermissions>
) {
  return PermissionService.getPermissions(...args);
}

export async function createPermission(data: {
  name: string;
  key: string;
  description?: string | null;
}) {
  await PermissionService.createPermission(
    data.name,
    data.key,
    data.description
  );
  revalidatePath("/permissions");
  return { success: true };
}

export async function updatePermission(
  permissionId: string,
  data: {
    name?: string;
    description?: string | null;
    key?: string;
  }
) {
  await PermissionService.updatePermission(permissionId, data);
  revalidatePath("/permissions");
  return { success: true };
}

export async function deletePermission(permissionId: string) {
  await PermissionService.deletePermission(permissionId);
  revalidatePath("/permissions");
  return { success: true };
}

// fetchPermissions
export async function fetchPermissions() {
  return PermissionService.list();
}

================
File: src/app/admin/permissions/columns.tsx
================
"use client";
import { ColumnDef } from "@tanstack/react-table";
import { Permission } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deletePermission } from "./actions";
import Link from "next/link";
import { RemoveButton } from "./_components/remove-button";

export const columns: ColumnDef<Permission>[] = [
  {
    accessorKey: "name",
    header: "æƒé™åç§°",
  },
  {
    accessorKey: "key",
    header: "æƒé™é”®",
  },
  {
    accessorKey: "description",
    header: "æè¿°",
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const permission = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæƒé™å—ï¼Ÿ")) return;
        await deletePermission(permission.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/permissions/${permission.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/permissions/new/drawer.tsx
================
"use client";

import * as React from "react";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";
import { Button } from "@/components/ui/button";
import { PermissionForm } from "../_components/permission-form";

export function PermissionsDrawer() {
  return (
    <Sheet>
      <SheetTrigger asChild>
        <Button variant="outline">æ–°å»ºæƒé™</Button>
      </SheetTrigger>
      <SheetContent side="right">
        <div className="w-full max-w-sm">
          <SheetHeader>
            <SheetTitle>æ–°å»ºæƒé™</SheetTitle>
            <SheetDescription>åˆ›å»ºä¸€ä¸ªæ–°çš„æƒé™</SheetDescription>
          </SheetHeader>
          <div className="mt-4">
            <PermissionForm />
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}

================
File: src/app/admin/permissions/new/page.tsx
================
import { Metadata } from "next";
import { PermissionForm } from "../_components/permission-form";

export const metadata: Metadata = {
  title: "æ–°å»ºæƒé™",
  description: "åˆ›å»ºæ–°çš„ç³»ç»Ÿæƒé™",
};

export default function NewPermissionPage() {
  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">æ–°å»ºæƒé™</h1>
      <PermissionForm />
    </div>
  );
}

================
File: src/app/admin/permissions/page.tsx
================
import { columns } from "./columns";
import PageTable from "@/components/page-table";
import { Metadata } from "next";
import { PermissionService } from "@/service/permission.service";
import { PermissionsDrawer } from "./new/drawer";

export const metadata: Metadata = {
  title: "æƒé™ç®¡ç†",
  description: "ç®¡ç†ç³»ç»Ÿæƒé™",
};
export default async function PermissionPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">æƒé™ç®¡ç†</h1>
        <PermissionsDrawer />
      </div>
      <PageTable
        basePath="/permissions"
        load={PermissionService.getPermissions}
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/profile/_components/form.tsx
================
"use client";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { useToast } from "@/hooks/use-toast";
import { useEffect, useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { PencilIcon } from "lucide-react";
import { changePassword, updateProfile } from "../actions";
import type { Admin } from "@prisma/client";
import { ADMIN_ROLE, ADMIN_ROLE_NAME } from "@/service/enum/ADMIN_ROLE";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

const nicknameFormSchema = z.object({
  nickname: z.string().min(2, {
    message: "æ˜µç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦",
  }),
});

const passwordFormSchema = z.object({
  oldPassword: z.string().min(6, {
    message: "å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦",
  }),
  newPassword: z.string().min(6, {
    message: "å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦",
  }),
});

export function ProfileForm(props: { user: Admin }) {
  const { user } = props;
  const { toast } = useToast();
  const [isEditNickname, setIsEditNickname] = useState(false);

  const nicknameForm = useForm<z.infer<typeof nicknameFormSchema>>({
    resolver: zodResolver(nicknameFormSchema),
    defaultValues: {
      nickname: user?.nickname || "",
    },
  });

  const passwordForm = useForm<z.infer<typeof passwordFormSchema>>({
    resolver: zodResolver(passwordFormSchema),
    defaultValues: {
      oldPassword: "",
      newPassword: "",
    },
  });

  useEffect(() => {
    if (user?.nickname) {
      nicknameForm.setValue("nickname", user.nickname);
    }
  }, [nicknameForm, user.nickname]);

  async function onSubmitNickname(values: z.infer<typeof nicknameFormSchema>) {
    try {
      const result = await updateProfile({ nickname: values.nickname });
      if (!result?.success) {
        toast({
          variant: "destructive",
          title: "ä¿®æ”¹å¤±è´¥",
          description: "è¯·ç¨åé‡è¯•",
        });
      }
      toast({
        title: "ä¿®æ”¹æˆåŠŸ",
        description: "æ˜µç§°å·²æ›´æ–°",
      });
      setIsEditNickname(false);
    } catch (_error) {
      toast({
        variant: "destructive",
        title: "ä¿®æ”¹å¤±è´¥",
        description: "è¯·ç¨åé‡è¯•",
      });
    }
  }

  async function onSubmitPassword(values: z.infer<typeof passwordFormSchema>) {
    try {
      const result = await changePassword({
        oldPassword: values.oldPassword,
        newPassword: values.newPassword,
      });
      if (!result?.success) {
        throw new Error();
      }
      toast({
        title: "ä¿®æ”¹æˆåŠŸ",
        description: "å¯†ç å·²æ›´æ–°",
      });
      passwordForm.reset();
    } catch (_error) {
      toast({
        variant: "destructive",
        title: "ä¿®æ”¹å¤±è´¥",
        description: "è¯·æ£€æŸ¥åŸå¯†ç æ˜¯å¦æ­£ç¡®",
      });
    }
  }

  return (
    <div className="space-y-8">
      <Card>
        <CardContent>
          <CardHeader className="hidden"></CardHeader>
          <div className="flex items-center space-x-4 pt-4">
            <Avatar className="h-20 w-20">
              <AvatarImage src={user?.avatar || ""} />
              <AvatarFallback>{user?.nickname?.[0]}</AvatarFallback>
            </Avatar>
            <div className="space-y-1">
              <div className="flex items-center space-x-2">
                <h3 className="text-2xl font-semibold">{user?.nickname}</h3>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => setIsEditNickname(true)}
                >
                  <PencilIcon className="h-4 w-4" />
                </Button>
              </div>
              <p className="text-sm text-muted-foreground">{user.email}</p>
              <p className="text-sm text-muted-foreground">
                è§’è‰²: {ADMIN_ROLE_NAME[user.role as ADMIN_ROLE]}
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardContent className="">
          <CardHeader>
            <CardTitle>ä¿®æ”¹å¯†ç </CardTitle>
          </CardHeader>
          <Form {...passwordForm}>
            <form
              onSubmit={passwordForm.handleSubmit(onSubmitPassword)}
              className="space-y-4"
            >
              <FormField
                control={passwordForm.control}
                name="oldPassword"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>åŸå¯†ç </FormLabel>
                    <FormControl>
                      <Input type="password" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={passwordForm.control}
                name="newPassword"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>æ–°å¯†ç </FormLabel>
                    <FormControl>
                      <Input type="password" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button type="submit">ä¿®æ”¹å¯†ç </Button>
            </form>
          </Form>
        </CardContent>
      </Card>

      <Dialog open={isEditNickname} onOpenChange={setIsEditNickname}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ä¿®æ”¹æ˜µç§°</DialogTitle>
          </DialogHeader>
          <Form {...nicknameForm}>
            <form
              onSubmit={nicknameForm.handleSubmit(onSubmitNickname)}
              className="space-y-4"
            >
              <FormField
                control={nicknameForm.control}
                name="nickname"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>æ˜µç§°</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button type="submit">ä¿å­˜</Button>
            </form>
          </Form>
        </DialogContent>
      </Dialog>
    </div>
  );
}

================
File: src/app/admin/profile/actions.ts
================
"use server";
import { auth } from "@/lib/auth";
import { AdminService } from "@/service/admin.service";
import { revalidatePath } from "next/cache";

export async function updateProfile({ nickname }: { nickname: string }) {
  const session = await auth();
  if (!session?.user?.id) return;
  const adminId = session.user.id;
  await AdminService.changeNickname(adminId, nickname);
  revalidatePath("/admin/profile");
  return { success: true };
}

export async function changePassword({
  oldPassword,
  newPassword,
}: {
  oldPassword: string;
  newPassword: string;
}) {
  const session = await auth();
  if (!session?.user?.id) return;
  const adminId = session.user.id;
  await AdminService.changePassword(adminId, oldPassword, newPassword);
  return { success: true };
}

================
File: src/app/admin/profile/loading.tsx
================
export { SkeletonForm as default } from "@/components/skeleton/form";

================
File: src/app/admin/profile/page.tsx
================
import { Metadata } from "next";
import { ProfileForm } from "./_components/form";
import { auth } from "@/lib/auth";
import { notFound } from "next/navigation";
import { AdminService } from "@/service/admin.service";

export const metadata: Metadata = {
  title: "ä¸ªäººä¿¡æ¯",
};

export default async function ProfilePage() {
  const session = await auth();
  if (!session?.user?.id) {
    return notFound();
  }
  const admin = await AdminService.getAdmin(session.user.id);
  if (!admin) {
    return notFound();
  }
  return (
    <div className="flex-1 space-y-4 p-8 pt-6">
      <div className="flex items-center justify-between space-y-2">
        <h2 className="text-3xl font-bold tracking-tight">ä¸ªäººä¿¡æ¯</h2>
      </div>
      <div className="grid gap-4">
        <ProfileForm user={admin} />
      </div>
    </div>
  );
}

================
File: src/app/admin/roles/_components/remove-button.tsx
================
import {
  AlertDialogHeader,
  AlertDialogFooter,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import {
  AlertDialog,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogCancel,
  AlertDialogAction,
} from "@/components/ui/alert-dialog";
import { Trash2 } from "lucide-react";

export function RemoveButton(props: { onDeleteAction: () => void }) {
  const { onDeleteAction } = props;
  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button className="w-full justify-start  text-red-400" variant="ghost">
          <Trash2 className="mr-2 h-4 w-4" />
          åˆ é™¤
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>
          <AlertDialogDescription>
            æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
          <AlertDialogAction onClick={onDeleteAction}>åˆ é™¤</AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}

================
File: src/app/admin/roles/_components/role-form.tsx
================
"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useRouter } from "next/navigation";
import { Role } from "@prisma/client";
import { createRole, updateRole } from "../actions";

const roleFormSchema = z.object({
  name: z.string().min(1, "è§’è‰²åç§°ä¸èƒ½ä¸ºç©º"),
  description: z.string().optional(),
});

type RoleFormValues = z.infer<typeof roleFormSchema>;

interface RoleFormProps {
  initialData?: Role;
}

export function RoleForm({ initialData }: RoleFormProps) {
  const router = useRouter();
  const form = useForm<RoleFormValues>({
    resolver: zodResolver(roleFormSchema),
    defaultValues: initialData || {
      name: "",
      description: "",
    },
  });

  async function onSubmit(data: RoleFormValues) {
    try {
      if (initialData) {
        await updateRole(initialData.id, data);
      } else {
        await createRole(data);
      }
      router.push("/roles");
      router.refresh();
    } catch (error) {
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>è§’è‰²åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥è§’è‰²åç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æè¿°</FormLabel>
              <FormControl>
                <Textarea placeholder="è¯·è¾“å…¥è§’è‰²æè¿°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/roles/[id]/page.tsx
================
import { Metadata } from "next";
import { RoleForm } from "../_components/role-form";
import { notFound } from "next/navigation";
import { RoleService } from "@/service/role.service";

export const metadata: Metadata = {
  title: "ç¼–è¾‘è§’è‰²",
  description: "ç¼–è¾‘ç³»ç»Ÿè§’è‰²",
};

export default async function EditRolePage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  const role = await RoleService.getRoleById(id);

  if (!role) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">ç¼–è¾‘è§’è‰²</h1>
      <RoleForm initialData={role} />
    </div>
  );
}

================
File: src/app/admin/roles/actions.ts
================
"use server";

import { RoleService } from "@/service/role.service";
import { revalidatePath } from "next/cache";

export async function getRoles(
  ...args: Parameters<typeof RoleService.getRoles>
) {
  return RoleService.getRoles(...args);
}

export async function createRole(data: { name: string; description?: string }) {
  try {
    await RoleService.createRole(data);
    revalidatePath("/roles");
    return { success: true };
  } catch (_error) {
    throw new Error("åˆ›å»ºè§’è‰²å¤±è´¥");
  }
}

export async function updateRole(
  roleId: string,
  data: {
    name?: string;
    description?: string;
  }
) {
  try {
    await RoleService.updateRole(roleId, data);
    revalidatePath("/roles");
    return { success: true };
  } catch (_error) {
    throw new Error("æ›´æ–°è§’è‰²å¤±è´¥");
  }
}

export async function deleteRole(roleId: string) {
  try {
    await RoleService.deleteRole(roleId);
    revalidatePath("/roles");
    return { success: true };
  } catch (_error) {
    throw new Error("åˆ é™¤è§’è‰²å¤±è´¥");
  }
}

================
File: src/app/admin/roles/columns.tsx
================
"use client";
import { ColumnDef } from "@tanstack/react-table";
import { Role } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deleteRole } from "./actions";
import Link from "next/link";
import { RemoveButton } from "./_components/remove-button";

export const columns: ColumnDef<Role>[] = [
  {
    accessorKey: "name",
    header: "è§’è‰²åç§°",
  },
  {
    accessorKey: "description",
    header: "æè¿°",
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const role = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ")) return;
        await deleteRole(role.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/roles/${role.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/roles/new/page.tsx
================
import { Metadata } from "next";
import { RoleForm } from "../_components/role-form";

export const metadata: Metadata = {
  title: "æ–°å»ºè§’è‰²",
  description: "åˆ›å»ºæ–°çš„ç³»ç»Ÿè§’è‰²",
};

export default function NewRolePage() {
  return (
    <div className="container mx-auto py-10">
      <h1 className="mb-4 text-2xl font-bold">æ–°å»ºè§’è‰²</h1>
      <RoleForm />
    </div>
  );
}

================
File: src/app/admin/roles/page.tsx
================
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";
import { Metadata } from "next";
import { RoleService } from "@/service/role.service";
export const metadata: Metadata = {
  title: "è§’è‰²ç®¡ç†",
  description: "ç®¡ç†ç³»ç»Ÿè§’è‰²å’Œæƒé™",
};
export default async function RolesPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">è§’è‰²ç®¡ç†</h1>
        <Link href="/roles/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºè§’è‰²
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/roles"
        load={RoleService.getRoles}
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/admin/webhooks/_components/form.tsx
================
"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";
import { CozeWebhook } from "@prisma/client";
import { createWebhook, updateWebhook } from "../actions";
import { useToast } from "@/hooks/use-toast";

const webhookFormSchema = z.object({
  name: z.string().min(1, "åç§°ä¸èƒ½ä¸ºç©º"),
  url: z.string().url("è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€"),
  authorization: z.string().min(1, "æˆæƒå¯†é’¥ä¸èƒ½ä¸ºç©º"),
});

type WebhookFormValues = z.infer<typeof webhookFormSchema>;

interface WebhookFormProps {
  initialData?: CozeWebhook;
}

export function WebhookForm({ initialData }: WebhookFormProps) {
  const router = useRouter();
  const { toast } = useToast();

  const form = useForm<WebhookFormValues>({
    resolver: zodResolver(webhookFormSchema),
    defaultValues: initialData || {
      name: "",
      url: "",
      authorization: "",
    },
  });

  async function onSubmit(data: WebhookFormValues) {
    try {
      if (initialData) {
        await updateWebhook(initialData.id, data);
      } else {
        await createWebhook(data);
      }
      router.replace("/admin/webhooks");
      router.refresh();
      toast({
        title: "æ“ä½œæˆåŠŸ",
        description: "Webhookå·²åˆ›å»º",
      });
    } catch (error) {
      toast({
        title: "æ“ä½œå¤±è´¥",
        description: error instanceof Error ? error.message : "æ“ä½œå¤±è´¥",
        variant: "destructive",
      });
      console.error("æäº¤å¤±è´¥:", error);
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <FormField
          control={form.control}
          name="name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>åç§°</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥Webhookåç§°" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="url"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Webhookåœ°å€</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥Webhookåœ°å€" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="authorization"
          render={({ field }) => (
            <FormItem>
              <FormLabel>æˆæƒå¯†é’¥</FormLabel>
              <FormControl>
                <Input placeholder="è¯·è¾“å…¥æˆæƒå¯†é’¥" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit">{initialData ? "æ›´æ–°" : "åˆ›å»º"}</Button>
      </form>
    </Form>
  );
}

================
File: src/app/admin/webhooks/[id]/page.tsx
================
import { notFound } from "next/navigation";
import { WebhookForm } from "../_components/form";
import { getWebhook } from "../actions";

interface EditWebhookPageProps {
  params: Promise<{ id: string }>;
}

export default async function EditWebhookPage({
  params,
}: EditWebhookPageProps) {
  const { id } = await params;
  const webhook = await getWebhook(id);

  if (!webhook) {
    notFound();
  }

  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">ç¼–è¾‘Webhook</h1>
      </div>
      <div className="rounded-md border p-4">
        <WebhookForm initialData={webhook} />
      </div>
    </div>
  );
}

================
File: src/app/admin/webhooks/actions.ts
================
"use server";

import { db } from "@/lib/db";
import { revalidatePath } from "next/cache";

// è·å–Webhookåˆ—è¡¨
export async function getWebhooks(
  query: PageableQuery<typeof db.cozeWebhook> = { page: 1, pageSize: 10 }
) {
  const skip = (query.page - 1) * query.pageSize;
  const [total, data] = await Promise.all([
    db.cozeWebhook.count({ where: query.where }),
    db.cozeWebhook.findMany({
      skip,
      take: query.pageSize,
      orderBy: {
        createdAt: "desc",
      },
      where: query.where,
      include: {
        _count: {
          select: {
            apiEndpoints: true,
            logs: true,
          },
        },
      },
    }),
  ]);

  return {
    data,
    total,
    page: query.page,
    pageSize: query.pageSize,
    totalPages: Math.ceil(total / query.pageSize),
  };
}

// åˆ›å»ºWebhook
export async function createWebhook(data: {
  url: string;
  authorization: string;
}) {
  const webhook = await db.cozeWebhook.create({
    data,
  });
  revalidatePath("/webhooks");
  return webhook;
}

// æ›´æ–°Webhook
export async function updateWebhook(
  id: string,
  data: {
    url: string;
    authorization: string;
  }
) {
  const webhook = await db.cozeWebhook.update({
    where: { id },
    data,
  });
  revalidatePath("/webhooks");
  return webhook;
}

// åˆ é™¤Webhook
export async function deleteWebhook(id: string) {
  await db.cozeWebhook.delete({
    where: { id },
  });
  revalidatePath("/webhooks");
}

// è·å–å•ä¸ªWebhook
export async function getWebhook(id: string) {
  return db.cozeWebhook.findUnique({
    where: { id },
  });
}

================
File: src/app/admin/webhooks/columns.tsx
================
"use client";

import { ColumnDef } from "@tanstack/react-table";
import { CozeWebhook } from "@prisma/client";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Edit } from "lucide-react";
import { deleteWebhook } from "./actions";
import Link from "next/link";
import { RemoveButton } from "@/components/remove-button";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";

type WebhookWithCount = CozeWebhook & {
  _count: {
    apiEndpoints: number;
    logs: number;
  };
};

export const columns: ColumnDef<WebhookWithCount>[] = [
  {
    accessorKey: "name",
    header: "åç§°",
  },
  {
    accessorKey: "url",
    header: "Webhookåœ°å€",
    cell: ({ row }) => {
      const url = row.original.url;
      return (
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger className="max-w-[200px] truncate">
              {url}
            </TooltipTrigger>
            <TooltipContent>
              <p className="max-w-[400px] break-all">{url}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      );
    },
  },
  {
    accessorKey: "authorization",
    header: "æˆæƒå¯†é’¥",
  },
  {
    accessorKey: "_count.apiEndpoints",
    header: "APIç«¯ç‚¹æ•°",
  },
  {
    accessorKey: "_count.logs",
    header: "æ—¥å¿—æ•°",
  },
  {
    accessorKey: "createdAt",
    header: "åˆ›å»ºæ—¶é—´",
    cell: ({ row }) => {
      return new Date(row.original.createdAt).toLocaleString();
    },
  },
  {
    id: "actions",
    cell: ({ row }) => {
      const webhook = row.original;
      const handleDelete = async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªWebhookå—ï¼Ÿ")) return;
        await deleteWebhook(webhook.id);
        window.location.reload();
      };
      return (
        <div className="flex gap-2">
          <Link href={`/admin/webhooks/${webhook.id}`}>
            <Button className="h-8 py-0" variant={"ghost"}>
              ç¼–è¾‘
              <Edit className="h-4 w-4" />
            </Button>
          </Link>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">æ‰“å¼€èœå•</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <RemoveButton onDeleteAction={handleDelete} />
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      );
    },
  },
];

================
File: src/app/admin/webhooks/new/page.tsx
================
import Image from "next/image";
import { WebhookForm } from "../_components/form";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export default function NewWebhookPage() {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">æ–°å»ºWebhook</h1>
      </div>
      <div className="mb-6 rounded-md border p-4">
        <WebhookForm />
      </div>
      <Card>
        <CardHeader>
          <CardTitle>Coze Webhook è®¾ç½®æŒ‡å—</CardTitle>
        </CardHeader>
        <CardContent>
          <Image
            src="/coze_webhook_guide.png"
            alt="Coze Webhook è®¾ç½®æŒ‡å—"
            width={600}
            height={400}
            className="mb-4"
          />
          <ol className="list-inside list-decimal space-y-2">
            <li>æ‰“å¼€æ™ºèƒ½ä½“ç¼–è¾‘</li>
            <li>åˆ›å»ºè§¦å‘å™¨ï¼Œé€‰æ‹©webå›è°ƒ</li>
            <li>è·å¾—å›è°ƒçš„åœ°å€è·Ÿæˆæƒç ï¼ˆæ³¨æ„ä¸éœ€è¦Bearerï¼‰</li>
          </ol>
        </CardContent>
      </Card>
    </div>
  );
}

================
File: src/app/admin/webhooks/page.tsx
================
import { getWebhooks } from "./actions";
import { columns } from "./columns";
import { Button } from "@/components/ui/button";
import { Plus } from "lucide-react";
import Link from "next/link";
import PageTable from "@/components/page-table";

export default async function WebhooksPage(props: PageProps) {
  return (
    <div className="container mx-auto py-10">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">Webhookç®¡ç†</h1>
        <Link href="/admin/webhooks/new">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            æ–°å»ºWebhook
          </Button>
        </Link>
      </div>
      <PageTable
        basePath="/admin/webhooks"
        load={(data) =>
          getWebhooks({
            page: data.page,
            pageSize: data.pageSize,
            where: data.keyword
              ? {
                  OR: [
                    { name: { contains: data.keyword } },
                    { url: { contains: data.keyword } },
                    { authorization: { contains: data.keyword } },
                  ],
                }
              : {},
          })
        }
        columns={columns}
        searchParams={props.searchParams}
      />
    </div>
  );
}

================
File: src/app/api/[[...slugs]]/route.ts
================
import { app } from "@/api";

export const GET = app.handle;
export const POST = app.handle;
export const PUT = app.handle;
export const DELETE = app.handle;

================
File: src/app/api/[api_id]/route.ts
================
import { ApiEndpointsService } from "@/service/api-endpoints.service";

export async function POST(
  request: Request,
  { params }: { params: Promise<{ api_id: string }> }
) {
  const { api_id } = await params;
  const json = await request.json();
  const apiKey = request.headers.get("Authorization");
  if (!apiKey) {
    return new Response(JSON.stringify({ error: "Unauthorized" }), {
      status: 401,
      headers: { "Content-Type": "application/json" },
    });
  }
  try {
    const coze = await ApiEndpointsService.getClient(apiKey.slice(7), api_id);
    const { hookId } = await coze.send(json);
    let result: string | undefined;
    let attempts = 0;
    const maxAttempts = 30;
    while (!result && attempts < maxAttempts) {
      const query = await coze.coze.query(hookId);
      result = query?.status === "success" ? query?.data : "";
      if (!result) {
        await new Promise((resolve) => setTimeout(resolve, 300));
      }
      attempts++;
    }
    if (!result) {
      throw new Error("Max query attempts reached");
    }

    const cozeResponse = JSON.parse(result);

    return Response.json(cozeResponse);
  } catch (error) {
    const message =
      error instanceof Error ? error.message : "Internal Server Error";
    return new Response(JSON.stringify({ error: message }), {
      status: 401,
      headers: { "Content-Type": "application/json" },
    });
  }
}

export function GET() {
  return new Response("Hello!");
}

================
File: src/app/api/admin/api-endpoints/[id]/keys/route.ts
================
import { NextRequest, NextResponse } from "next/server";
import { getEndpointKeys } from "@/app/admin/api-endpoints/actions";

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get("page") || "1");
  const pageSize = parseInt(searchParams.get("pageSize") || "10");

  try {
    const result = await getEndpointKeys(params.id, {
      page,
      pageSize,
    });

    return NextResponse.json(result);
  } catch (error) {
    return NextResponse.json(
      { error: "è·å–å¯†é’¥åˆ—è¡¨å¤±è´¥" },
      { status: 500 }
    );
  }
}

================
File: src/app/api/auth/[...nextauth]/route.ts
================
import { handlers } from "@/lib/auth" // Referring to the auth.ts we just created
export const { GET, POST } = handlers

================
File: src/app/api/v1/chat/completion/route.ts
================
import { ApiEndpointsService } from "@/service/api-endpoints.service";
import { chatCompletionSchema } from "./schema";
import { v4 as uuidv4 } from "uuid";

export async function POST(request: Request) {
  const json = await request.json();
  const apiKey = request.headers.get("Authorization");
  if (!apiKey) {
    return new Response(JSON.stringify({ error: "Unauthorized" }), {
      status: 401,
      headers: { "Content-Type": "application/json" },
    });
  }
  try {
    const parsed = chatCompletionSchema.safeParse(json);
    if (!parsed.success) {
      return new Response(JSON.stringify({ error: parsed.error }), {
        status: 400,
        headers: { "Content-Type": "application/json" },
      });
    }

    const chat = parsed.data;
    const coze = await ApiEndpointsService.getClient(
      apiKey.slice(7),
      chat.model
    );
    const system_prompt =
      chat.messages?.find((item) => item.role === "system")?.content ??
      "You are a helpful assistant.";
    const { hookId } = await coze.send({
      prompt: chat.messages
        .filter((item) => item.role !== "system")
        .map((item) => {
          return `${item.role}: ${item.content}`;
        })
        .join("\n--\n"),
      system_prompt,
    });
    let result: string | undefined;
    let attempts = 0;
    const maxAttempts = 30;
    while (!result && attempts < maxAttempts) {
      const query = await coze.coze.query(hookId);
      result = query?.status === "success" ? query?.data : "";
      if (!result) {
        await new Promise((resolve) => setTimeout(resolve, 300));
      }
      attempts++;
    }
    if (!result) {
      throw new Error("Max query attempts reached");
    }

    const cozeResponse = JSON.parse(result) as { content: string };

    return Response.json({
      id: uuidv4(),
      object: "chat.completion",
      created: Date.now(),
      model: chat.model,
      systemfingerprint: "fp_3a5770e1b4",
      choices: [
        {
          index: 0,
          message: {
            role: "assistant",
            content: cozeResponse.content,
          },
          logprobs: null,
          finishreason: "stop",
        },
      ],
      usage: {
        prompttokens: 11,
        completiontokens: 11,
        totaltokens: 22,
        promptcachehittokens: 0,
        promptcachemisstokens: 11,
      },
    });
  } catch (error) {
    const message =
      error instanceof Error ? error.message : "Internal Server Error";
    return new Response(JSON.stringify({ error: message }), {
      status: 401,
      headers: { "Content-Type": "application/json" },
    });
  }
}

export function GET() {
  return new Response("Hello!");
}

================
File: src/app/api/v1/chat/completion/schema.ts
================
import { z } from "zod";

export const chatCompletionSchema = z.object({
  model: z.string(),
  messages: z.array(
    z.object({
      role: z.enum(["system", "user", "assistant"]),
      content: z.string(),
    })
  ),
});

export type ChatCompletion = z.infer<typeof chatCompletionSchema>;

================
File: src/app/global.css
================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 240 10% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 240 10% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 240 10% 3.9%;
    --primary: 240 5.9% 10%;
    --primary-foreground: 0 0% 98%;
    --secondary: 240 4.8% 95.9%;
    --secondary-foreground: 240 5.9% 10%;
    --muted: 240 4.8% 95.9%;
    --muted-foreground: 240 3.8% 46.1%;
    --accent: 240 4.8% 95.9%;
    --accent-foreground: 240 5.9% 10%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 5.9% 90%;
    --input: 240 5.9% 90%;
    --ring: 240 10% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
    --sidebar-background: 0 0% 98%;
    --sidebar-foreground: 240 5.3% 26.1%;
    --sidebar-primary: 240 5.9% 10%;
    --sidebar-primary-foreground: 0 0% 98%;
    --sidebar-accent: 240 4.8% 95.9%;
    --sidebar-accent-foreground: 240 5.9% 10%;
    --sidebar-border: 220 13% 91%;
    --sidebar-ring: 217.2 91.2% 59.8%;
  }
  .dark,
  [data-theme="dark"] {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 10% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 240 10% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 240 5.9% 10%;
    --secondary: 240 3.7% 15.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 3.7% 15.9%;
    --muted-foreground: 240 5% 64.9%;
    --accent: 240 3.7% 15.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 3.7% 15.9%;
    --input: 240 3.7% 15.9%;
    --ring: 240 4.9% 83.9%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
    --sidebar-background: 240 5.9% 10%;
    --sidebar-foreground: 240 4.8% 95.9%;
    --sidebar-primary: 224.3 76.3% 48%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 240 3.7% 15.9%;
    --sidebar-accent-foreground: 240 4.8% 95.9%;
    --sidebar-border: 240 3.7% 15.9%;
    --sidebar-ring: 217.2 91.2% 59.8%;
  }
}

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 20 14.3% 4.1%;
    --card: 0 0% 100%;
    --card-foreground: 20 14.3% 4.1%;
    --popover: 0 0% 100%;
    --popover-foreground: 20 14.3% 4.1%;
    --primary: 24.6 95% 53.1%;
    --primary-foreground: 60 9.1% 97.8%;
    --secondary: 60 4.8% 95.9%;
    --secondary-foreground: 24 9.8% 10%;
    --muted: 60 4.8% 95.9%;
    --muted-foreground: 25 5.3% 44.7%;
    --accent: 60 4.8% 95.9%;
    --accent-foreground: 24 9.8% 10%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 60 9.1% 97.8%;
    --border: 20 5.9% 90%;
    --input: 20 5.9% 90%;
    --ring: 24.6 95% 53.1%;
    --radius: 0.75rem;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
  }

  .dark {
    --background: 20 14.3% 4.1%;
    --foreground: 60 9.1% 97.8%;
    --card: 20 14.3% 4.1%;
    --card-foreground: 60 9.1% 97.8%;
    --popover: 20 14.3% 4.1%;
    --popover-foreground: 60 9.1% 97.8%;
    --primary: 20.5 90.2% 48.2%;
    --primary-foreground: 60 9.1% 97.8%;
    --secondary: 12 6.5% 15.1%;
    --secondary-foreground: 60 9.1% 97.8%;
    --muted: 12 6.5% 15.1%;
    --muted-foreground: 24 5.4% 63.9%;
    --accent: 12 6.5% 15.1%;
    --accent-foreground: 60 9.1% 97.8%;
    --destructive: 0 72.2% 50.6%;
    --destructive-foreground: 60 9.1% 97.8%;
    --border: 12 6.5% 15.1%;
    --input: 12 6.5% 15.1%;
    --ring: 20.5 90.2% 48.2%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

================
File: src/app/layout.tsx
================
import type { Metadata } from "next";
import "./global.css";
import { NuqsAdapter } from "nuqs/adapters/next/app";

import { Toaster } from "@/components/ui/toaster";
import { ThemeProvider } from "@/components/theme-provider";

declare global {
  type SearchParams = Promise<{ [key: string]: string }>;
  type PageProps = {
    searchParams: SearchParams;
  };
}

export const metadata: Metadata = {
  title: "æ‰£å­æœåŠ¡ç®¡ç†ç³»ç»Ÿ",
  description: "ä¸€é”®ç®¡ç†æ‰£å­webhookæœåŠ¡",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html suppressHydrationWarning lang="en">
      <body>
        <ThemeProvider
          attribute="class"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          <NuqsAdapter>{children}</NuqsAdapter>

          <Toaster />
        </ThemeProvider>
      </body>
    </html>
  );
}

================
File: src/app/login/page.tsx
================
import { GalleryVerticalEnd } from "lucide-react";

import { LoginForm } from "@/components/auth/login-form";

export default function LoginPage() {
  return (
    <div className="grid min-h-svh lg:grid-cols-2">
      <div className="flex flex-col gap-4 p-6 md:p-10">
        <div className="flex justify-center gap-2 md:justify-start">
          <a href="#" className="flex items-center gap-2 font-medium">
            <div className="flex h-6 w-6 items-center justify-center rounded-md bg-primary text-primary-foreground">
              <GalleryVerticalEnd className="size-4" />
            </div>
            æ‰£å­HookæœåŠ¡
          </a>
        </div>
        <div className="flex flex-1 items-center justify-center">
          <div className="w-[500px] max-w-full">
            <LoginForm />
          </div>
        </div>
      </div>
      <div className="relative hidden bg-muted lg:block">
        <img
          src="/placeholder.svg"
          alt="Image"
          className="absolute inset-0 h-full w-full object-cover dark:brightness-[0.2] dark:grayscale"
        />
      </div>
    </div>
  );
}

================
File: src/app/not-found.tsx
================
import Link from "next/link";
import { Button } from "@/components/ui/button";

export default function NotFound() {
  return (
    <div className="flex h-[100vh] flex-col items-center justify-center">
      <div className="text-center">
        <h1 className="bg-gradient-to-r from-primary to-secondary-foreground bg-clip-text text-8xl font-extrabold text-transparent">
          404
        </h1>
        <h2 className="mt-4 text-2xl font-semibold text-foreground">
          é¡µé¢æœªæ‰¾åˆ°
        </h2>
        <p className="mt-2 text-muted-foreground">
          æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤ã€‚
        </p>
        <div className="mt-8">
          <Button asChild>
            <Link
              href="/admin/dashboard"
              className="inline-flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className="lucide lucide-home"
              >
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />

                <polyline points="9 22 9 12 15 12 15 22" />
              </svg>
              è¿”å›é¦–é¡µ
            </Link>
          </Button>
        </div>
      </div>
      <div className="mt-16 text-center text-sm text-muted-foreground">
        <p>å¦‚æœæ‚¨è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚</p>
      </div>
    </div>
  );
}

================
File: src/app/page.tsx
================
import { LandingNav } from "@/components/landing/nav";
import { Hero } from "@/components/landing/hero";
import { Features } from "@/components/landing/features";

export default function Page() {
  return (
    <div className="flex min-h-screen flex-col">
      <LandingNav />
      <main className="flex-1">
        <Hero />
        <Features />
      </main>
      <footer className="border-t py-6 md:py-0">
        <div className="container mx-auto flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
          <div className="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
            <p className="text-center text-sm leading-loose text-muted-foreground md:text-left">
              Built by{" "}
              <a
                href="#"
                target="_blank"
                rel="noreferrer"
                className="font-medium underline underline-offset-4"
              >
                Your Company
              </a>
              . The source code is available on{" "}
              <a
                href="#"
                target="_blank"
                rel="noreferrer"
                className="font-medium underline underline-offset-4"
              >
                GitHub
              </a>
              .
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
}

================
File: src/app/webhook/[id]/route.ts
================
import { NextRequest } from "next/server";
import { CozeWebhookService } from "@/service/coze-webhook";

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const json = await request.json();
  const coze = await CozeWebhookService.getClient(id);
  if ("action" in json) {
    const action = json.action as string;
    if (action === "query") {
      const hookId = json.hookId;
      const result = await coze.query(hookId);
      return Response.json(result);
    }
    if (action === "callback" && "hookId" in json && "body" in json) {
      const hookId = json.hookId;
      const data = json.body;
      const result = await coze.complte(
        hookId,
        typeof data === "string" ? data : JSON.stringify(data)
      );
      return Response.json(result);
    }
  }
  return Response.json({ error: "invalid action" });
}

================
File: src/app/webhook/lib.ts
================
import { MemoryCache } from "@/lib/cache";
import { v4 as uuidv4 } from "uuid";

const WebhookCache = new MemoryCache<{
  start: number;
  end?: number;
  data?: string;
  status: "success" | "wait";
}>();

class CozeWebhookError extends Error {
  constructor(message: string) {
    super(message);
    this.name = "CozeWebhookError";
  }
}

export class CozeWebhook {
  url: string;
  authorization: string;
  id: string;
  callback: string;
  constructor({
    url,
    id,
    authorization,
    callback,
  }: {
    url: string;
    id: string;
    authorization: string;
    callback?: string;
  }) {
    this.id = id;
    this.url = url;
    this.authorization = authorization;
    this.callback =
      callback ?? `${process.env.NEXT_PUBLIC_API_URL}/webhook/${id}`;
  }

  //   è½¬å‘ç»™coze
  async send(data: Record<string, string>) {
    // è°ƒç”¨æˆåŠŸå°±åˆ›å»ºç¼“å­˜
    const hookId = uuidv4();
    const response = await fetch(this.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: this.authorization,
      },
      body: JSON.stringify({
        ...data,
        hookId,
        callback: this.callback,
      }),
    });
    const result = (await response.json()) as {
      code: number;
      message: string;
    };
    if (result.code != 0) {
      throw new CozeWebhookError(result.message);
    }

    await WebhookCache.set(hookId, {
      start: Date.now(),
      status: "success",
    });
    return {
      hookId,
      data: result,
    };
  }

  async query(hookId: string) {
    const hook = WebhookCache.get(hookId);
    if (!hook) {
      throw new CozeWebhookError("hook not found");
    }
    return hook;
  }

  async complte(hookId: string, data: string) {
    const hook = await WebhookCache.get(hookId);
    if (!hook) {
      throw new CozeWebhookError("hook not found");
    }
    await WebhookCache.update(
      hookId,
      {
        data,
        status: "success",
        end: Date.now(),
      },
      60 * 1000
    );
    return {
      hookId,
      data,
    };
  }
}

================
File: src/hooks/use-mobile.tsx
================
import * as React from "react";

const MOBILE_BREAKPOINT = 768;

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(
    undefined
  );

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    };
    mql.addEventListener("change", onChange);
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  return !!isMobile;
}

================
File: src/hooks/use-toast.ts
================
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }

================
File: src/instrumentation.ts
================
export async function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") {
    await import("@/service/admin.service").then(({ AdminService }) => {
      return AdminService.createDefaultAdmin();
    });

    await import("pino");
  }

  if (process.env.NEXT_RUNTIME === "edge") {
  }
}

================
File: src/lib/auth.base.ts
================
import { ADMIN_ROLE } from "@/service/enum/ADMIN_ROLE";
import NextAuth, { DefaultSession, NextAuthConfig } from "next-auth";
declare module "next-auth" {
  interface Session {
    user: {
      username: string;
      role: string;
      nickname: string;
    } & DefaultSession["user"];
  }
}

export const authOptions: NextAuthConfig = {
  pages: {
    signIn: "/login",
  },
  session: {
    strategy: "jwt",
  },
  providers: [],
  callbacks: {
    async session({ token, session }) {
      if (token && session.user) {
        session.user.id = token.id as string;
        session.user.name = token.name as string;
        session.user.username = token.username as string;
        session.user.nickname = token.nickname as string;
        session.user.role = token.role as string;
        session.user.email = token.email as string;
      }
      return session;
    },
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.name = user.name;
        token.email = user.email;
        if ("username" in user && typeof user.username === "string") {
          token.username = user.username;
        }
        if ("nickname" in user && typeof user.nickname === "string") {
          token.nickname = user.nickname;
        }
        if ("type" in user && typeof user.type === "string") {
          token.role = user.type;
        }
      }
      return token;
    },
  },
};
export const { auth } = NextAuth(authOptions);

================
File: src/lib/auth.ts
================
import CredentialsProvider from "next-auth/providers/credentials";
import { authOptions } from "@/lib/auth.base";
import NextAuth, { NextAuthConfig } from "next-auth";
import { AdminService } from "@/service/admin.service";
export const providers: NextAuthConfig["providers"] = [
  CredentialsProvider({
    name: "Credentials",
    credentials: {
      email: { label: "è´¦å·", type: "email" },
      password: { label: "å¯†ç ", type: "password" },
    },
    async authorize(credentials) {
      try {
        const user = await AdminService.login(
          credentials.email as string,
          credentials.password as string
        );
        return user;
      } catch (_error) {
        return null;
      }
    },
  }),
];
export const { handlers, signIn, signOut, auth } = NextAuth({
  ...authOptions,
  providers: [...authOptions.providers, ...providers],
});

================
File: src/lib/cache.ts
================
export interface Cache<T> {
  get(key: string): Promise<T | undefined>;
  set(key: string, value: T, ttl?: number): Promise<void>;
  delete(key: string): Promise<void>;
  update(key: string, partialValue: Partial<T>, ttl?: number): Promise<void>;
  clear(): Promise<void>;
}

export class MemoryCache<T> implements Cache<T> {
  private cache: Map<string, { value: T; expiry: number | null }> = new Map();

  async get(key: string): Promise<T | undefined> {
    const item = this.cache.get(key);
    if (!item) return undefined;
    if (item.expiry !== null && item.expiry < Date.now()) {
      await this.delete(key);
      return undefined;
    }
    return item.value;
  }
  async set(key: string, value: T, ttl?: number): Promise<void> {
    const expiry = ttl ? Date.now() + ttl * 1000 : null;
    this.cache.set(key, { value, expiry });
  }

  async update(
    key: string,
    partialValue: Partial<T>,
    ttl?: number
  ): Promise<void> {
    const existingItem = this.cache.get(key);
    if (!existingItem) {
      throw new Error("Item not found in cache");
    }
    const updatedValue = { ...existingItem.value, ...partialValue };
    const expiry = ttl ? Date.now() + ttl * 1000 : existingItem.expiry;
    this.cache.set(key, { value: updatedValue, expiry });
  }

  async delete(key: string): Promise<void> {
    this.cache.delete(key);
  }

  async clear(): Promise<void> {
    this.cache.clear();
  }
}

================
File: src/lib/db.ts
================
import { Prisma, PrismaClient } from "@prisma/client";

function createPrisma() {
  return new PrismaClient().$extends({
    model: {
      $allModels: {
        async exists<T>(
          this: T,
          where: Prisma.Args<T, "findFirst">["where"]
        ): Promise<boolean> {
          const context = Prisma.getExtensionContext(this);
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          const result = await (context as any).findFirst({ where });
          return result !== null;
        },
      },
    },
  });
}

declare global {
  // eslint-disable-next-line no-var
  var cachedPrisma: ReturnType<typeof createPrisma>;
}

let prisma: ReturnType<typeof createPrisma>;
if (process.env.NODE_ENV === "production") {
  prisma = createPrisma();
} else {
  if (!global.cachedPrisma) {
    global.cachedPrisma = createPrisma();
  }
  prisma = global.cachedPrisma;
}

export const db = prisma;

================
File: src/lib/upload.ts
================
export async function uploadImage(file: File): Promise<string> {
  // è¿™é‡Œå®ç°å®é™…çš„å›¾ç‰‡ä¸Šä¼ é€»è¾‘
  // è¿”å›ä¸Šä¼ åçš„å›¾ç‰‡URL
  return new Promise((resolve) => {
    const reader = new FileReader()
    reader.onloadend = () => {
      // ä¸´æ—¶ä½¿ç”¨ Base64 ä½œä¸ºå›¾ç‰‡URL
      // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨æœåŠ¡
      resolve(reader.result as string)
    }
    reader.readAsDataURL(file)
  })
}

================
File: src/lib/utils.ts
================
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
export function formatDuration(ms: number): string {
  const hours = Math.floor(ms / (1000 * 60 * 60));
  return `${hours.toLocaleString()}å°æ—¶`;
}

export function formatDate(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

// æ ¼å¼åŒ–æˆ YYYY-MM-DD HH:MM
export function formatDateTime(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  const hours = String(date.getHours()).padStart(2, "0");
  const minutes = String(date.getMinutes()).padStart(2, "0");
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

export function getGreeting(): string {
  const hour = new Date().getHours();
  if (hour < 6) return "æ·±å¤œå¥½";
  if (hour < 9) return "æ—©ä¸Šå¥½";
  if (hour < 12) return "ä¸Šåˆå¥½";
  if (hour < 14) return "ä¸­åˆå¥½";
  if (hour < 17) return "ä¸‹åˆå¥½";
  if (hour < 19) return "å‚æ™šå¥½";
  if (hour < 22) return "æ™šä¸Šå¥½";
  return "æ·±å¤œå¥½";
}

================
File: src/lib/validations/auth.ts
================
import * as z from "zod";

export const loginSchema = z.object({
  email: z.string().email("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€"),
  password: z.string().min(3, "å¯†ç è‡³å°‘3ä¸ªå­—ç¬¦"),
});

export const registerSchema = z.object({
  email: z.string().email("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€"),
  password: z.string().min(6, "å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦"),
  nickname: z.string().min(2, "æ˜µç§°è‡³å°‘2ä¸ªå­—ç¬¦"),
});

================
File: src/lib/validations/device.ts
================
import * as z from 'zod'

export const deviceSchema = z.object({
  serialNumber: z.string().min(1, 'è¯·è¾“å…¥è®¾å¤‡åºåˆ—å·'),
  alias: z.string().min(1, 'è¯·è¾“å…¥è®¾å¤‡åˆ«å')
})

================
File: src/middleware.ts
================
import { auth } from "./lib/auth.base";
import { ADMIN_ROLE } from "./service/enum/ADMIN_ROLE";

export default auth((req) => {
  const user = req.auth?.user;
  const isAdmin =
    user?.role === ADMIN_ROLE.ADMIN || user?.role === ADMIN_ROLE.SUPERADMIN;
  if (!isAdmin && req.nextUrl.pathname !== "/login") {
    const newUrl = new URL("/login", req.nextUrl.origin);
    return Response.redirect(newUrl);
  }
});

export const config = {
  matcher: [
    "/admins/:path*",
  ],
};

================
File: src/service/admin.service.ts
================
import { db } from "@/lib/db";
import { compare, hash } from "bcrypt";
import { ADMIN_ROLE } from "./enum/ADMIN_ROLE";
import { Admin } from "@prisma/client";

export class AdminService {
  // åˆ›å»ºç®¡ç†å‘˜
  static async createAdmin(
    email: string,
    username: string,
    password: string,
    data?: {
      nickname?: string;
      phone?: string;
      type?: ADMIN_ROLE;
    }
  ) {
    const exists = await db.admin.findUnique({
      where: { email },
    });

    if (exists) {
      throw new Error("é‚®ç®±å·²è¢«æ³¨å†Œ");
    }

    const hashedPassword = await hash(password, 10);

    return db.admin.create({
      data: {
        email,
        username,
        password: hashedPassword,
        ...data,
      },
    });
  }

  // è·å¾—ç®¡ç†å‘˜
  static async getAdmin(adminId: string) {
    return db.admin.findUnique({
      where: { id: adminId },
    });
  }

  // è·å–ç®¡ç†å‘˜åˆ—è¡¨
  static async getAdmins(
    query: PageableQuery<typeof db.admin> = { page: 1, pageSize: 10 }
  ) {
    const skip = (query.page - 1) * query.pageSize;
    const [total, data] = await Promise.all([
      db.admin.count({ where: query.where }),
      db.admin.findMany({
        skip,
        take: query.pageSize,
        orderBy: {
          createdAt: "desc",
        },
        where: query.where,
      }),
    ]);

    return {
      data,
      total,
      page: query.page,
      pageSize: query.pageSize,
      totalPages: Math.ceil(total / query.pageSize),
    };
  }

  // æ›´æ–°ç®¡ç†å‘˜ä¿¡æ¯
  static async updateAdmin(
    adminId: string,
    data: {
      email?: string;
      password?: string;
      nickname?: string;
      phone?: string;
      role?: ADMIN_ROLE;
    }
  ) {
    const { password, ...rest } = data;
    const updateData: Partial<Admin> = { ...rest };

    if (password) {
      updateData.password = await hash(password, 10);
    }

    return db.admin.update({
      where: {
        id: adminId,
      },
      data: updateData,
    });
  }

  // åˆ é™¤ç®¡ç†å‘˜
  static async deleteAdmin(adminId: string) {
    return db.admin.delete({
      where: {
        id: adminId,
      },
    });
  }
  /**
   *
   * @param account ç™»å½•è´¦å·æˆ–è€…é‚®ç®±
   * @param password
   * @returns
   */
  static async login(account: string, password: string) {
    const admin = await db.admin.findFirst({
      where: {
        OR: [{ email: account }, { username: account }],
      },
    });

    if (!admin) {
      throw new Error("è´¦å·æˆ–è€…å¯†ç é”™è¯¯");
    }

    const isValid = await compare(password, admin.password);

    if (!isValid) {
      throw new Error("è´¦å·æˆ–è€…å¯†ç é”™è¯¯");
    }

    return {
      id: admin.id,
      email: admin.email,
      username: admin.username,
      nickname: admin.nickname,
      name: admin.nickname,
      phone: admin.phone,
    };
  }

  // ä¿®æ”¹å¯†ç 
  static async changePassword(
    adminId: string,
    oldPassword: string,
    newPassword: string
  ) {
    const admin = await db.admin.findUnique({
      where: { id: adminId },
    });

    if (!admin) {
      throw new Error("ç®¡ç†å‘˜ä¸å­˜åœ¨");
    }

    const isValid = await compare(oldPassword, admin.password);

    if (!isValid) {
      throw new Error("åŸå¯†ç é”™è¯¯");
    }

    const hashedPassword = await hash(newPassword, 10);

    return db.admin.update({
      where: { id: adminId },
      data: { password: hashedPassword },
    });
  }

  // ä¿®æ”¹æ˜µç§°
  static async changeNickname(adminId: string, newNickname: string) {
    const admin = await db.admin.findUnique({
      where: { id: adminId },
    });

    if (!admin) {
      throw new Error("ç®¡ç†å‘˜ä¸å­˜åœ¨");
    }

    return db.admin.update({
      where: { id: adminId },
      data: { nickname: newNickname },
    });
  }

  static async createDefaultAdmin() {
    const exists = await db.admin.findUnique({
      where: { email: "admin@admin.com" },
    });
    if (exists) return;
    await db.admin.create({
      data: {
        email: "admin@admin.com",
        username: "admin",
        nickname: "admin",
        phone: "admin",
        type: ADMIN_ROLE.SUPERADMIN,
        password: await hash("admin", 10),
      },
    });
    console.log("é»˜è®¤ç®¡ç†å‘˜å·²åˆ›å»º,è´¦å·ï¼šadmin@admin.comï¼Œå¯†ç ï¼šadmin");
  }
}

================
File: src/service/api-endpoints.service.ts
================
import { db } from "@/lib/db";
import { CozeWebhook } from "./coze-webhook";

export class ApiEndpointsService {
  /**
   * Retrieves an API endpoint by its ID
   * @param {string} id - The unique identifier of the API endpoint
   * @returns {Promise<Object>} A promise that resolves to an object containing the API endpoint data and its path
   * @throws {Error} If the API endpoint is not found
   */
  static async getApiendpoint(id: string) {
    const apiEndpoint = await db.apiEndpoint.findUnique({
      where: { id },
      include: {
        cozeWebhook: true,
      },
    });

    if (!apiEndpoint) {
      throw new Error("API endpoint not found");
    }

    const path =
      apiEndpoint.type === "openaiLike"
        ? "/api/v1/chat/completion"
        : `/api/${apiEndpoint.id}`;

    return {
      ...apiEndpoint,
      path,
    };
  }

  /**
   * è·å¾—cozeçš„æ“ä½œ
   * @param apiKey
   * @param id
   * @returns
   */
  static async getClient(apiKey: string, id: string) {
    const apiKeys = await db.apiKey.findFirst({
      where: {
        key: apiKey,
        apiEndpoints: {
          some: {
            id,
          },
        },
      },
      include: {
        apiEndpoints: {
          include: {
            cozeWebhook: true,
          },
        },
      },
    });

    if (!apiKeys) {
      throw new Error("API key not found");
    }
    const apiEndpoint = apiKeys.apiEndpoints.find((item) => item.id === id);

    if (!apiEndpoint) {
      throw new Error("API endpoint not found");
    }
    const coze = new CozeWebhook(apiEndpoint.cozeWebhook);

    return {
      coze,
      /**
       * å‘é€
       * @param data
       * @returns
       */
      send: (data: Record<string, string>) => {
        return coze.send(apiEndpoint.id, apiKey, data);
      },
    };
  }
}

================
File: src/service/coze-webhook.ts
================
import { MemoryCache } from "@/lib/cache";
import { db } from "@/lib/db";
import { v4 as uuidv4 } from "uuid";
type CozeCache = {
  logId: string;
  start: number;
  data?: string;
  status: "success" | "wait";
};
declare global {
  // eslint-disable-next-line no-var
  var WebhookCache: MemoryCache<CozeCache>;
}

let WebhookCache: MemoryCache<CozeCache>;
if (process.env.NODE_ENV === "production") {
  WebhookCache = new MemoryCache<CozeCache>();
} else {
  if (!global.WebhookCache) {
    global.WebhookCache = new MemoryCache<CozeCache>();
  }
  WebhookCache = global.WebhookCache;
}

export class CozeWebhookService {
  static async getClient(id: string) {
    const webhook = await db.cozeWebhook.findUnique({
      where: {
        id,
      },
    });

    if (!webhook) {
      throw new CozeWebhookError("webhook not found");
    }

    return new CozeWebhook({
      url: webhook.url,
      id: webhook.id,
      authorization: webhook.authorization,
    });
  }
}

class CozeWebhookError extends Error {
  constructor(message: string) {
    super(message);
    this.name = "CozeWebhookError";
  }
}

export class CozeWebhook {
  url: string;
  authorization: string;
  id: string;
  callback: string;
  constructor({
    url,
    id,
    authorization,
    callback,
  }: {
    url: string;
    id: string;
    authorization: string;
    callback?: string;
  }) {
    this.id = id;
    this.url = url;
    this.authorization = authorization;
    this.callback =
      callback ?? `${process.env.NEXT_PUBLIC_API_URL}/webhook/${id}`;
  }

  //   è½¬å‘ç»™coze
  async send(
    apiEndpointId: string,
    apiKey: string,
    data: Record<string, string>
  ) {
    const hookId = uuidv4();
    const log = await db.apiEndpointLog.create({
      data: {
        apiEndpointId: apiEndpointId,
        cozeWebhookId: this.id,
        requestParams: JSON.stringify(data),
        apiKey: apiKey,
      },
    });
    const response = await fetch(this.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${this.authorization}`,
      },
      body: JSON.stringify({
        ...data,
        hookId,
        callback: this.callback,
      }),
    });
    const result = (await response.json()) as {
      code: number;
      message: string;
    };
    if (result.code != 0) {
      throw new CozeWebhookError(result.message);
    }

    await WebhookCache.set(hookId, {
      logId: log.id,
      start: Date.now(),
      status: "success",
    });

    return {
      hookId,
      data: result,
    };
  }

  async query(hookId: string) {
    const hook = WebhookCache.get(hookId);
    if (!hook) {
      throw new CozeWebhookError("hook not found");
    }
    return hook;
  }

  async complte(hookId: string, data: string) {
    const hook = await WebhookCache.get(hookId);
    if (!hook) {
      throw new CozeWebhookError("hook not found");
    }

    await db.apiEndpointLog.update({
      data: {
        duration: Date.now() - hook.start,
        response: data,
      },
      where: {
        id: hook.logId,
      },
    });

    await WebhookCache.update(
      hookId,
      {
        data,
        status: "success",
      },
      60 * 1000
    );
    return {
      hookId,
      data,
    };
  }
}

================
File: src/service/enum/ADMIN_ROLE.ts
================
export enum ADMIN_ROLE {
  ADMIN = "admin",
  SUPERADMIN = "superadmin",
}

export const ADMIN_ROLE_NAME: Record<ADMIN_ROLE, string> = {
  [ADMIN_ROLE.ADMIN]: "ç®¡ç†å‘˜",
  [ADMIN_ROLE.SUPERADMIN]: "è¶…çº§ç®¡ç†å‘˜",
};

================
File: src/service/menu.service.ts
================
import { db } from "@/lib/db";

export class MenuService {
  // åˆ›å»ºèœå•
  static async createMenu(
    name: string,
    url: string,
    sort: number,
    parentId?: string | null,
    icon?: string | null,
    permissionIds?: string[]
  ) {
    return db.menu.create({
      data: {
        name,
        url,
        sort,
        parentId,
        icon,
        permissions: {
          connect: permissionIds?.map((id) => ({ id })) || [],
        },
      },
    });
  }

  // getMenuById
  static async getMenuById(id: string) {
    return db.menu.findUnique({
      where: { id },
    });
  }

  // è·å–å•ä¸ªèœå•
  static async getMenu(menuId: string) {
    return db.menu.findUnique({
      where: { id: menuId },
      include: {
        permissions: true,
      },
    });
  }

  // list
  static async list() {
    return db.menu.findMany({
      orderBy: {
        sort: "asc",
      },
    });
  }

  // è·å–èœå•åˆ—è¡¨
  static async getMenus(
    query: PageableQuery<typeof db.menu> = { page: 1, pageSize: 10 }
  ) {
    const skip = (query.page - 1) * query.pageSize;
    const [total, data] = await Promise.all([
      db.menu.count({ where: query.where }),
      db.menu.findMany({
        skip,
        take: query.pageSize,
        orderBy: {
          sort: "asc",
        },
        where: query.where,
        include: {
          permissions: true,
        },
      }),
    ]);

    return {
      data,
      total,
      page: query.page,
      pageSize: query.pageSize,
      totalPages: Math.ceil(total / query.pageSize),
    };
  }

  // æ›´æ–°èœå•ä¿¡æ¯
  static async updateMenu(
    menuId: string,
    data: {
      name?: string;
      url?: string;
      sort?: number;
      parentId?: string | null;
      icon?: string | null;
      permissionIds?: string[];
    }
  ) {
    return db.menu.update({
      where: {
        id: menuId,
      },
      data: {
        ...data,
        permissions: {
          set: data.permissionIds?.map((id) => ({ id })) || [],
        },
      },
    });
  }

  // åˆ é™¤èœå•
  static async deleteMenu(menuId: string) {
    return db.menu.delete({
      where: {
        id: menuId,
      },
    });
  }
}

================
File: src/service/permission.service.ts
================
import { db } from "@/lib/db";

export class PermissionService {
  // åˆ›å»ºæƒé™
  static async createPermission(
    name: string,
    key: string,
    description?: string | null,
    parentId?: string | null
  ) {
    const exists = await db.permission.findUnique({
      where: { key },
    });

    if (exists) {
      throw new Error("æƒé™å·²å­˜åœ¨");
    }

    return db.permission.create({
      data: {
        name,
        key,
        description,
        parentId,
      },
    });
  }

  // getPermissionById
  static async getPermissionById(id: string) {
    return db.permission.findUnique({
      where: { id },
    });
  }

  // è·å–å•ä¸ªæƒé™
  static async getPermission(permissionId: string) {
    const permission = await db.permission.findUnique({
      where: { id: permissionId },
      include: {
        children: true,
      },
    });
    return permission;
  }

  // list
  static async list() {
    return db.permission.findMany({
      orderBy: {
        createdAt: "desc",
      },
    });
  }

  // è·å–æƒé™åˆ—è¡¨
  static async getPermissions(
    query: PageableQuery<typeof db.permission> = { page: 1, pageSize: 10 }
  ) {
    const skip = (query.page - 1) * query.pageSize;
    const [total, data] = await Promise.all([
      db.permission.count({ where: query.where }),
      db.permission.findMany({
        skip,
        take: query.pageSize,
        orderBy: {
          createdAt: "desc",
        },
        where: query.where,
        include: {
          children: true,
        },
      }),
    ]);

    return {
      data,
      total,
      page: query.page,
      pageSize: query.pageSize,
      totalPages: Math.ceil(total / query.pageSize),
    };
  }

  // æ›´æ–°æƒé™ä¿¡æ¯
  static async updatePermission(
    permissionId: string,
    data: {
      name?: string;
      key?: string;
      description?: string | null;
      parentId?: string | null;
    }
  ) {
    const exists = await db.permission.findUnique({
      where: { key: data.key },
    });
    if (exists && exists.id !== permissionId) {
      throw new Error("æƒé™å·²å­˜åœ¨");
    }

    return db.permission.update({
      where: {
        id: permissionId,
      },
      data,
    });
  }

  // åˆ é™¤æƒé™
  static async deletePermission(permissionId: string) {
    return db.permission.delete({
      where: {
        id: permissionId,
      },
    });
  }
}

================
File: src/service/role.service.ts
================
import { db } from "@/lib/db";

export class RoleService {
  /**
   * è·å–è§’è‰²åˆ—è¡¨
   */
  static async getRoles(
    { page, pageSize, where }: PageableQuery<typeof db.role> = {
      page: 1,
      pageSize: 10,
    }
  ) {
    const skip = (page - 1) * pageSize;
    const [data, total] = await Promise.all([
      db.role.findMany({
        skip,
        take: pageSize,
        include: {
          admins: true,
          permissions: true,
        },
        orderBy: { createdAt: "desc" },
        where,
      }),
      db.role.count({ where }),
    ]);

    return {
      data,
      total,
      page,
      pageSize,
    };
  }

  // getRoleById
  static async getRoleById(id: string) {
    return db.role.findUnique({ where: { id } });
  }

  /**
   * åˆ›å»ºè§’è‰²
   */
  static async createRole(data: {
    name: string;
    code: string;
    description?: string;
    permissions?: string[];
  }) {
    return db.role.create({
      data: {
        ...data,
        permissions: {
          connect: data.permissions?.map((permission) => ({ id: permission })),
        },
      },
    });
  }

  /**
   * æ›´æ–°è§’è‰²
   */
  static async updateRole(
    id: string,
    data: {
      name?: string;
      description?: string;
      permissions?: string[];
    }
  ) {
    return db.role.update({
      where: { id },
      data: {
        ...data,
        permissions: data.permissions
          ? {
              connect: data.permissions.map((permission) => ({
                id: permission,
              })),
            }
          : undefined,
      },
    });
  }

  /**
   * åˆ é™¤è§’è‰²
   */
  static async deleteRole(id: string) {
    return db.role.delete({ where: { id } });
  }
}
